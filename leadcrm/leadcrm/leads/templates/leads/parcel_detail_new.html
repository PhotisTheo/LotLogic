{% extends "leads/base.html" %}

{% block title %}{{ parcel.site_address|default:parcel.loc_id }} - Property Details{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    /* Hero Section */
    .property-hero {
      position: relative;
      height: 400px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: -24px -24px 24px -24px;
      overflow: hidden;
    }

    .property-hero-image {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .property-hero-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
      padding: 40px;
      color: white;
    }

    .property-hero-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0 0 8px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .property-hero-subtitle {
      font-size: 1.125rem;
      opacity: 0.95;
      margin-bottom: 16px;
    }

    .property-hero-stats {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .property-hero-stat {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
    }

    /* Alert Banners */
    .alert-banner-row {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .alert-banner {
      flex: 1;
      min-width: 200px;
      padding: 16px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .alert-banner-danger {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
    }

    .alert-banner-warning {
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      color: #333;
    }

    .alert-banner-info {
      background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
      color: white;
    }

    .alert-banner-icon {
      font-size: 1.5rem;
    }

    /* Key Metrics */
    .metrics-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .metric-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .metric-value {
      font-size: 2.25rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .metric-label {
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
    }

    .metric-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      margin: 0 auto 16px;
    }

    /* Tabs */
    .detail-tabs {
      background: white;
      border-radius: 16px;
      padding: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 24px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .detail-tab {
      flex: 1;
      min-width: 120px;
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 10px;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }

    .detail-tab:hover {
      background: #f3f4f6;
      color: #1f2937;
    }

    .detail-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    /* Tab Content */
    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Info Cards */
    .info-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      margin-bottom: 20px;
    }

    .info-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f3f4f6;
    }

    .info-card-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
    }

    .info-card-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
    }

    .info-item {
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .info-item-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .info-item-value {
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
    }

    /* Table Styling */
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .data-table thead th {
      background: #f9fafb;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      border-bottom: 2px solid #e5e7eb;
    }

    .data-table tbody td {
      padding: 16px;
      border-bottom: 1px solid #f3f4f6;
    }

    .data-table tbody tr:hover {
      background: #f9fafb;
    }

    /* Action Buttons */
    .action-bar {
      position: sticky;
      top: 72px;
      background: white;
      padding: 16px 24px;
      margin: -24px -24px 24px -24px;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      z-index: 100;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-action {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-action-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }

    .btn-action-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .property-hero {
        height: 300px;
        margin: -16px -16px 16px -16px;
      }

      .property-hero-title {
        font-size: 1.75rem;
      }

      .property-hero-overlay {
        padding: 24px;
      }

      .metrics-row {
        grid-template-columns: repeat(2, 1fr);
      }

      .detail-tabs {
        flex-direction: column;
      }

      .detail-tab {
        flex: none;
      }

      .action-bar {
        margin: -16px -16px 16px -16px;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Action Bar -->
  <div class="action-bar">
    <a class="btn btn-action btn-outline-secondary" href="{% url 'parcel_search' %}">
      <i class="bi bi-arrow-left"></i> Back to Search
    </a>
    <button class="btn btn-action btn-action-primary">
      <i class="bi bi-bookmark"></i> Save to List
    </button>
    <button class="btn btn-action btn-outline-primary">
      <i class="bi bi-download"></i> Export
    </button>
    <button class="btn btn-action btn-outline-secondary">
      <i class="bi bi-share"></i> Share
    </button>
  </div>

  <!-- Hero Section with Street View -->
  <div class="property-hero">
    <iframe class="property-hero-image" id="heroStreetView" src="" allowfullscreen loading="lazy"></iframe>
    <div class="property-hero-overlay">
      <h1 class="property-hero-title">{{ parcel.site_address|default:parcel.loc_id }}</h1>
      <div class="property-hero-subtitle">
        {{ parcel.site_city|default:parcel.town.name }}{% if parcel.site_zip %}, MA {{ parcel.site_zip }}{% endif %}
      </div>
      <div class="property-hero-stats">
        <div class="property-hero-stat">
          <i class="bi bi-house-door me-2"></i>{{ parcel.property_category }}
        </div>
        <div class="property-hero-stat">
          <i class="bi bi-currency-dollar me-2"></i>{% if parcel.total_value %}${{ parcel.total_value|floatformat:0 }}{% else %}N/A{% endif %}
        </div>
        <div class="property-hero-stat">
          <i class="bi bi-rulers me-2"></i>{% if parcel.bld_area %}{{ parcel.bld_area|floatformat:0 }} sqft{% else %}N/A{% endif %}
        </div>
        {% if parcel.year_built %}
        <div class="property-hero-stat">
          <i class="bi bi-calendar me-2"></i>Built {{ parcel.year_built }}
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Alert Banners -->
  {% if attom_data.pre_foreclosure or liens or legal_actions %}
  <div class="alert-banner-row">
    {% if attom_data.pre_foreclosure %}
    <div class="alert-banner alert-banner-danger">
      <div class="alert-banner-icon">‚ö†Ô∏è</div>
      <div>
        <div style="font-size: 0.875rem; opacity: 0.9;">FORECLOSURE ACTIVE</div>
        <div style="font-size: 0.75rem; opacity: 0.8;">{{ attom_data.foreclosure_stage|default:"Pre-Foreclosure" }}</div>
      </div>
    </div>
    {% endif %}

    {% if liens %}
    <div class="alert-banner alert-banner-warning">
      <div class="alert-banner-icon">üî¥</div>
      <div>
        <div style="font-size: 0.875rem;">{{ liens|length }} LIEN{{ liens|length|pluralize }} FOUND</div>
        <div style="font-size: 0.75rem; opacity: 0.8;">Review required</div>
      </div>
    </div>
    {% endif %}

    {% if legal_actions %}
    <div class="alert-banner alert-banner-info">
      <div class="alert-banner-icon">‚öñÔ∏è</div>
      <div>
        <div style="font-size: 0.875rem;">{{ legal_actions|length }} LEGAL ACTION{{ legal_actions|length|pluralize }}</div>
        <div style="font-size: 0.75rem; opacity: 0.8;">Active cases</div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Key Metrics -->
  <div class="metrics-row">
    <div class="metric-card">
      <div class="metric-icon">
        <i class="bi bi-cash-stack"></i>
      </div>
      <div class="metric-value">{% if parcel.total_value %}${{ parcel.total_value|floatformat:0 }}{% else %}N/A{% endif %}</div>
      <div class="metric-label">Total Value</div>
    </div>

    <div class="metric-card">
      <div class="metric-icon">
        <i class="bi bi-percent"></i>
      </div>
      <div class="metric-value">{% if parcel.equity_percent %}{{ parcel.equity_percent|floatformat:0 }}%{% else %}N/A{% endif %}</div>
      <div class="metric-label">Equity</div>
    </div>

    <div class="metric-card">
      <div class="metric-icon">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
      <div class="metric-value">{{ liens|length|default:0 }}</div>
      <div class="metric-label">Active Liens</div>
    </div>

    <div class="metric-card">
      <div class="metric-icon">
        <i class="bi bi-person"></i>
      </div>
      <div class="metric-value">{% if parcel.absentee %}Absentee{% else %}Owner{% endif %}</div>
      <div class="metric-label">Occupancy</div>
    </div>
  </div>

  <!-- Tabbed Interface -->
  <div class="detail-tabs">
    <button class="detail-tab active" data-tab="overview">
      <i class="bi bi-house me-2"></i>Overview
    </button>
    <button class="detail-tab" data-tab="financial">
      <i class="bi bi-graph-up me-2"></i>Financial
    </button>
    <button class="detail-tab" data-tab="legal">
      <i class="bi bi-gavel me-2"></i>Legal & Liens
    </button>
    <button class="detail-tab" data-tab="property">
      <i class="bi bi-building me-2"></i>Property Details
    </button>
    <button class="detail-tab" data-tab="map">
      <i class="bi bi-map me-2"></i>Map & Location
    </button>
  </div>

  <!-- Overview Tab -->
  <div class="tab-panel active" data-panel="overview">
    {% if property_summary %}
    <div class="info-card">
      <div class="info-card-header">
        <div class="info-card-icon">
          <i class="bi bi-stars"></i>
        </div>
        <h2 class="info-card-title">AI Property Summary</h2>
      </div>
      <p style="font-size: 1.125rem; line-height: 1.7; color: #374151;">{{ property_summary }}</p>
    </div>
    {% endif %}

    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="info-card">
          <div class="info-card-header">
            <div class="info-card-icon">
              <i class="bi bi-info-circle"></i>
            </div>
            <h2 class="info-card-title">Owner Information</h2>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-item-label">Owner Name</div>
              <div class="info-item-value">{{ parcel.owner_name|default:"Not available" }}</div>
            </div>
            {% if parcel.owner_name_2 %}
            <div class="info-item">
              <div class="info-item-label">Co-Owner</div>
              <div class="info-item-value">{{ parcel.owner_name_2 }}</div>
            </div>
            {% endif %}
            <div class="info-item">
              <div class="info-item-label">Mailing Address</div>
              <div class="info-item-value">
                {% if parcel.owner_street %}
                  {{ parcel.owner_street }}<br>
                  {{ parcel.owner_city }}, {{ parcel.owner_state }} {{ parcel.owner_zip }}
                {% else %}
                  Not available
                {% endif %}
              </div>
            </div>
            <div class="info-item">
              <div class="info-item-label">Occupancy Status</div>
              <div class="info-item-value">
                <span class="badge {% if parcel.absentee %}bg-warning text-dark{% else %}bg-success{% endif %}">
                  {% if parcel.absentee %}Absentee Owner{% else %}Owner Occupied{% endif %}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="info-card">
          <div class="info-card-header">
            <div class="info-card-icon">
              <i class="bi bi-building"></i>
            </div>
            <h2 class="info-card-title">Property Characteristics</h2>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-item-label">Property Type</div>
              <div class="info-item-value">{{ parcel.property_category|default:"Unknown" }}</div>
            </div>
            <div class="info-item">
              <div class="info-item-label">Use Description</div>
              <div class="info-item-value">{{ parcel.use_description|default:"N/A" }}</div>
            </div>
            {% if parcel.style %}
            <div class="info-item">
              <div class="info-item-label">Building Style</div>
              <div class="info-item-value">{{ parcel.style }}</div>
            </div>
            {% endif %}
            {% if parcel.units %}
            <div class="info-item">
              <div class="info-item-label">Units</div>
              <div class="info-item-value">{{ parcel.units }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Financial Tab -->
  <div class="tab-panel" data-panel="financial">
    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="info-card">
          <div class="info-card-header">
            <div class="info-card-icon">
              <i class="bi bi-cash-stack"></i>
            </div>
            <h2 class="info-card-title">Valuation</h2>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-item-label">Total Assessed Value</div>
              <div class="info-item-value" style="font-size: 1.5rem; color: #059669;">
                {% if parcel.total_value %}${{ parcel.total_value|floatformat:0 }}{% else %}N/A{% endif %}
              </div>
            </div>
            <div class="info-item">
              <div class="info-item-label">Building Value</div>
              <div class="info-item-value">{% if parcel.building_value %}${{ parcel.building_value|floatformat:0 }}{% else %}N/A{% endif %}</div>
            </div>
            <div class="info-item">
              <div class="info-item-label">Land Value</div>
              <div class="info-item-value">{% if parcel.land_value %}${{ parcel.land_value|floatformat:0 }}{% else %}N/A{% endif %}</div>
            </div>
            <div class="info-item">
              <div class="info-item-label">Equity Percentage</div>
              <div class="info-item-value">{% if parcel.equity_percent %}{{ parcel.equity_percent|floatformat:1 }}%{% else %}N/A{% endif %}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="info-card">
          <div class="info-card-header">
            <div class="info-card-icon">
              <i class="bi bi-clock-history"></i>
            </div>
            <h2 class="info-card-title">Sale History</h2>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-item-label">Last Sale Date</div>
              <div class="info-item-value">{{ parcel.last_sale_date|default:"N/A" }}</div>
            </div>
            <div class="info-item">
              <div class="info-item-label">Last Sale Price</div>
              <div class="info-item-value">{% if parcel.last_sale_price %}${{ parcel.last_sale_price|floatformat:0 }}{% else %}N/A{% endif %}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if attom_data and attom_data.default_risk_score is not None %}
    <div class="info-card">
      <div class="info-card-header">
        <div class="info-card-icon">
          <i class="bi bi-graph-down"></i>
        </div>
        <h2 class="info-card-title">Default Risk Analysis</h2>
      </div>
      <div class="row align-items-center">
        <div class="col-12 col-md-4 text-center">
          <div style="font-size: 3rem; font-weight: 700; color: {% if attom_data.default_risk_score >= 70 %}#dc3545{% elif attom_data.default_risk_score >= 40 %}#ffc107{% else %}#28a745{% endif %};">
            {{ attom_data.default_risk_score }}
          </div>
          <div class="metric-label">Risk Score (0-100)</div>
        </div>
        <div class="col-12 col-md-8">
          <div class="progress" style="height: 30px; border-radius: 15px;">
            <div class="progress-bar {% if attom_data.default_risk_score >= 70 %}bg-danger{% elif attom_data.default_risk_score >= 40 %}bg-warning{% else %}bg-success{% endif %}"
                 role="progressbar"
                 style="width: {{ attom_data.default_risk_score }}%"
                 aria-valuenow="{{ attom_data.default_risk_score }}"
                 aria-valuemin="0"
                 aria-valuemax="100">
              {{ attom_data.default_risk_score }}%
            </div>
          </div>
          <p class="mt-3 mb-0 text-muted">
            {% if attom_data.default_risk_score >= 70 %}
              <strong class="text-danger">High Risk:</strong> This property shows elevated indicators for potential default or foreclosure.
            {% elif attom_data.default_risk_score >= 40 %}
              <strong class="text-warning">Medium Risk:</strong> This property shows moderate indicators that warrant monitoring.
            {% else %}
              <strong class="text-success">Low Risk:</strong> This property shows low indicators for default or foreclosure.
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Legal & Liens Tab -->
  <div class="tab-panel" data-panel="legal">
    {% if attom_data.pre_foreclosure %}
    <div class="info-card" style="border-left: 4px solid #dc3545;">
      <div class="info-card-header">
        <div class="info-card-icon" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
          <i class="bi bi-exclamation-triangle"></i>
        </div>
        <h2 class="info-card-title">Foreclosure Status</h2>
        <span class="badge bg-danger ms-auto">ACTIVE</span>
      </div>
      <div class="info-grid">
        {% if attom_data.foreclosure_stage %}
        <div class="info-item">
          <div class="info-item-label">Stage</div>
          <div class="info-item-value">{{ attom_data.foreclosure_stage }}</div>
        </div>
        {% endif %}
        {% if attom_data.foreclosure_recording_date %}
        <div class="info-item">
          <div class="info-item-label">Recording Date</div>
          <div class="info-item-value">{{ attom_data.foreclosure_recording_date }}</div>
        </div>
        {% endif %}
        {% if attom_data.foreclosure_auction_date %}
        <div class="info-item">
          <div class="info-item-label">Auction Date</div>
          <div class="info-item-value">{{ attom_data.foreclosure_auction_date }}</div>
        </div>
        {% endif %}
        {% if attom_data.foreclosure_default_amount %}
        <div class="info-item">
          <div class="info-item-label">Default Amount</div>
          <div class="info-item-value">${{ attom_data.foreclosure_default_amount|floatformat:0 }}</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <div class="info-card">
      <div class="info-card-header">
        <div class="info-card-icon">
          <i class="bi bi-file-earmark-text"></i>
        </div>
        <h2 class="info-card-title">Recorded Liens</h2>
        {% if liens %}
        <span class="badge bg-warning text-dark ms-auto">{{ liens|length }} Active</span>
        {% endif %}
      </div>
      {% if liens %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Holder</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date</th>
            <th>Source</th>
          </tr>
        </thead>
        <tbody>
          {% for lien in liens %}
          <tr>
            <td><span class="badge bg-secondary">{{ lien.type|default:"Unknown" }}</span></td>
            <td>{{ lien.holder|default:"N/A" }}</td>
            <td>{% if lien.amount %}${{ lien.amount|floatformat:0 }}{% else %}N/A{% endif %}</td>
            <td><span class="badge {% if lien.status == 'Active' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ lien.status|default:"Unknown" }}</span></td>
            <td>{{ lien.recording_date|default:"N/A" }}</td>
            <td><small class="text-muted">{{ lien.source|default:"Manual Entry" }}</small></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="text-center py-5">
        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
        <p class="mt-3 mb-0 fw-semibold">No liens found</p>
        <p class="text-muted small">This property appears to have no recorded liens.</p>
      </div>
      {% endif %}
    </div>

    <div class="info-card">
      <div class="info-card-header">
        <div class="info-card-icon">
          <i class="bi bi-gavel"></i>
        </div>
        <h2 class="info-card-title">Legal Actions</h2>
        {% if legal_actions %}
        <span class="badge bg-info ms-auto">{{ legal_actions|length }} Active</span>
        {% endif %}
      </div>
      {% if legal_actions %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Case Number</th>
            <th>Status</th>
            <th>Filed</th>
            <th>Parties</th>
          </tr>
        </thead>
        <tbody>
          {% for action in legal_actions %}
          <tr>
            <td>
              <span class="badge {% if action.action_type == 'foreclosure' %}bg-danger{% elif action.action_type == 'eviction' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                {{ action.action_type|title }}
              </span>
            </td>
            <td><code>{{ action.case_number }}</code></td>
            <td><span class="badge bg-info">{{ action.status|default:"Unknown" }}</span></td>
            <td>{{ action.filing_date|default:"N/A" }}</td>
            <td>
              <small>
                <strong>Plaintiff:</strong> {{ action.plaintiff|default:"N/A" }}<br>
                <strong>Defendant:</strong> {{ action.defendant|default:"N/A" }}
              </small>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="text-center py-5">
        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
        <p class="mt-3 mb-0 fw-semibold">No legal actions found</p>
        <p class="text-muted small">This property has no recorded legal actions.</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Property Details Tab -->
  <div class="tab-panel" data-panel="property">
    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="info-card">
          <div class="info-card-header">
            <div class="info-card-icon">
              <i class="bi bi-rulers"></i>
            </div>
            <h2 class="info-card-title">Building Information</h2>
          </div>
          <div class="info-grid">
            {% if parcel.bld_area %}
            <div class="info-item">
              <div class="info-item-label">Building Area</div>
              <div class="info-item-value">{{ parcel.bld_area|floatformat:0 }} sqft</div>
            </div>
            {% endif %}
            {% if parcel.year_built %}
            <div class="info-item">
              <div class="info-item-label">Year Built</div>
              <div class="info-item-value">{{ parcel.year_built }}</div>
            </div>
            {% endif %}
            {% if parcel.style %}
            <div class="info-item">
              <div class="info-item-label">Architectural Style</div>
              <div class="info-item-value">{{ parcel.style }}</div>
            </div>
            {% endif %}
            {% if parcel.units %}
            <div class="info-item">
              <div class="info-item-label">Number of Units</div>
              <div class="info-item-value">{{ parcel.units }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="info-card">
          <div class="info-card-header">
            <div class="info-card-icon">
              <i class="bi bi-geo-alt"></i>
            </div>
            <h2 class="info-card-title">Land Information</h2>
          </div>
          <div class="info-grid">
            {% if parcel.lot_size %}
            <div class="info-item">
              <div class="info-item-label">Lot Size</div>
              <div class="info-item-value">{{ parcel.lot_size|floatformat:2 }} {{ parcel.lot_units|default:"acres" }}</div>
            </div>
            {% endif %}
            {% if parcel.zoning %}
            <div class="info-item">
              <div class="info-item-label">Zoning</div>
              <div class="info-item-value">{{ parcel.zoning }}</div>
            </div>
            {% endif %}
            <div class="info-item">
              <div class="info-item-label">Parcel ID</div>
              <div class="info-item-value"><code>{{ parcel.loc_id }}</code></div>
            </div>
            <div class="info-item">
              <div class="info-item-label">Town</div>
              <div class="info-item-value">{{ parcel.town.name }} ({{ parcel.town.town_id }})</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Map & Location Tab -->
  <div class="tab-panel" data-panel="map">
    <div class="info-card">
      <div class="info-card-header">
        <div class="info-card-icon">
          <i class="bi bi-map"></i>
        </div>
        <h2 class="info-card-title">Property Location</h2>
      </div>
      <div id="propertyMap" style="width: 100%; height: 500px; border-radius: 12px;"></div>
    </div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.detail-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;

        // Update tabs
        document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update panels
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelector(`[data-panel="${targetTab}"]`).classList.add('active');

        // Initialize map if switching to map tab
        if (targetTab === 'map' && !window.propertyMapInitialized) {
          initPropertyMap();
        }
      });
    });

    // Initialize hero street view
    {% if parcel.centroid %}
    const lat = {{ parcel.centroid.0 }};
    const lng = {{ parcel.centroid.1 }};

    const heroParams = new URLSearchParams({
      'q': `${lat.toFixed(6)},${lng.toFixed(6)}`,
      'layer': 'c',
      'cbll': `${lat.toFixed(6)},${lng.toFixed(6)}`,
      'll': `${lat.toFixed(6)},${lng.toFixed(6)}`,
      'cbp': '11,0,0,0,0',
      'output': 'svembed'
    });
    document.getElementById('heroStreetView').src = `https://maps.google.com/maps?${heroParams.toString()}`;
    {% endif %}

    // Initialize property map
    function initPropertyMap() {
      {% if parcel.centroid %}
      const map = L.map('propertyMap').setView([lat, lng], 17);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      L.marker([lat, lng]).addTo(map);

      // Load parcel geometry
      fetch('/api/parcel/{{ parcel.town.town_id }}/{{ parcel.loc_id }}/geometry/')
        .then(response => response.json())
        .then(data => {
          if (data.geometry) {
            const geoJsonLayer = L.geoJSON(data.geometry, {
              style: {
                fillColor: '#667eea',
                fillOpacity: 0.3,
                color: '#764ba2',
                weight: 3
              }
            }).addTo(map);
            map.fitBounds(geoJsonLayer.getBounds(), { padding: [50, 50] });
          }
        });

      window.propertyMapInitialized = true;
      {% endif %}
    }
  </script>
{% endblock %}
