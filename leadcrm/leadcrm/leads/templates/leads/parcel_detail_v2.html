{% extends "leads/base.html" %}

{% block title %}{{ parcel.site_address|default:parcel.loc_id }} - Property Details{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    /* Modern hero section */
    .property-hero {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: -24px -24px 24px -24px;
      padding: 32px;
      color: white;
    }

    .property-hero-title {
      font-size: 2rem;
      font-weight: 700;
      margin: 0 0 8px 0;
    }

    .property-hero-subtitle {
      font-size: 1.125rem;
      opacity: 0.95;
      margin-bottom: 16px;
    }

    .property-hero-stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .property-hero-stat {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
    }

    /* Preview section */
    .preview-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .preview-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
    }

    .preview-card-header {
      padding: 16px 20px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
    }

    .preview-card-body {
      padding: 0;
      position: relative;
    }

    /* Alert banners */
    .alert-banners {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .alert-banner {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .alert-banner-danger {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #dc2626;
    }

    .alert-banner-warning {
      background: #fef3c7;
      color: #92400e;
      border-left: 4px solid #f59e0b;
    }

    /* Section cards */
    .section-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .section-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 700;
      font-size: 1.125rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-body {
      padding: 24px;
    }

    /* Data grid */
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .data-item {
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .data-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .data-value {
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
    }

    /* Collapsible section */
    .collapsible-section {
      margin-bottom: 20px;
    }

    .collapsible-header {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      transition: all 0.2s;
    }

    .collapsible-header:hover {
      background: #f9fafb;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .collapsible-header.active {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom-color: transparent;
    }

    .collapsible-body {
      display: none;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      background: white;
    }

    .collapsible-body.active {
      display: block;
    }

    .chevron {
      transition: transform 0.2s;
    }

    .chevron.active {
      transform: rotate(180deg);
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table thead th {
      background: #f9fafb;
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      border-bottom: 2px solid #e5e7eb;
    }

    .data-table tbody td {
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
    }

    .data-table tbody tr:hover {
      background: #f9fafb;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .property-hero {
        margin: -16px -16px 16px -16px;
        padding: 20px;
      }

      .property-hero-title {
        font-size: 1.5rem;
      }

      .preview-section {
        grid-template-columns: 1fr;
      }

      .data-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Hero Section -->
  <div class="property-hero">
    <h1 class="property-hero-title">{{ parcel.site_address|default:parcel.loc_id }}</h1>
    <div class="property-hero-subtitle">
      {{ parcel.site_city|default:parcel.town.name }}{% if parcel.site_zip %}, MA {{ parcel.site_zip }}{% endif %}
    </div>
    <div class="property-hero-stats">
      <div class="property-hero-stat">
        <i class="bi bi-house-door me-1"></i>{{ parcel.property_category }}
      </div>
      <div class="property-hero-stat">
        {% if parcel.absentee %}
          <i class="bi bi-person-x me-1"></i>Absentee Owner
        {% else %}
          <i class="bi bi-person-check me-1"></i>Owner Occupied
        {% endif %}
      </div>
      <div class="property-hero-stat">
        <i class="bi bi-currency-dollar me-1"></i>{% if parcel.total_value %}${{ parcel.total_value|floatformat:0 }}{% else %}N/A{% endif %}
      </div>
      {% if parcel.bld_area %}
      <div class="property-hero-stat">
        <i class="bi bi-rulers me-1"></i>{{ parcel.bld_area|floatformat:0 }} sqft
      </div>
      {% endif %}
      {% if parcel.year_built %}
      <div class="property-hero-stat">
        <i class="bi bi-calendar me-1"></i>Built {{ parcel.year_built }}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Action Bar -->
  <div class="d-flex flex-wrap gap-2 mb-4">
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'parcel_search' %}">
      <i class="bi bi-arrow-left me-1"></i> Back to Search
    </a>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'saved_parcel_lists' %}">
      <i class="bi bi-folder me-1"></i> Saved Lists
    </a>
  </div>

  <!-- Alert Banners -->
  {% if attom_data.pre_foreclosure or liens or legal_actions %}
  <div class="alert-banners">
    {% if attom_data.pre_foreclosure %}
    <div class="alert-banner alert-banner-danger">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <div>
        <strong>FORECLOSURE ACTIVE</strong>
        <div style="font-size: 0.75rem; opacity: 0.8;">{{ attom_data.foreclosure_stage|default:"Pre-Foreclosure" }}</div>
      </div>
    </div>
    {% endif %}
    {% if liens %}
    <div class="alert-banner alert-banner-warning">
      <i class="bi bi-file-earmark-text-fill"></i>
      <div>
        <strong>{{ liens|length }} LIEN{{ liens|length|pluralize }} FOUND</strong>
        <div style="font-size: 0.75rem; opacity: 0.8;">Review required</div>
      </div>
    </div>
    {% endif %}
    {% if legal_actions %}
    <div class="alert-banner alert-banner-warning">
      <i class="bi bi-gavel"></i>
      <div>
        <strong>{{ legal_actions|length }} LEGAL ACTION{{ legal_actions|length|pluralize }}</strong>
        <div style="font-size: 0.75rem; opacity: 0.8;">Active cases</div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- AI Summary -->
  {% if property_summary %}
  <div class="section-card">
    <div class="section-header">
      <i class="bi bi-stars"></i>
      AI Property Summary
    </div>
    <div class="section-body">
      <p style="font-size: 1.125rem; line-height: 1.7; margin: 0;">{{ property_summary }}</p>
    </div>
  </div>
  {% endif %}

  <!-- Street View & Property Preview -->
  <div class="preview-section">
    <div class="preview-card">
      <div class="preview-card-header">Street View</div>
      <div class="preview-card-body">
        <iframe id="streetViewFrame" style="width: 100%; height: 300px; border: 0;" allowfullscreen loading="lazy"></iframe>
      </div>
    </div>
    <div class="preview-card">
      <div class="preview-card-header">Property Preview</div>
      <div class="preview-card-body">
        {% if property_embed_url %}
          <iframe src="{{ property_embed_url }}" style="width: 100%; height: 300px; border: 0;" allowfullscreen loading="lazy"></iframe>
        {% elif google_maps and google_maps.lat and google_maps.lng %}
          <div id="parcel-map-embed"
               data-lat="{{ google_maps.lat }}"
               data-lng="{{ google_maps.lng }}"
               style="width: 100%; height: 300px;">
            <div class="d-flex align-items-center justify-content-center text-muted small" style="height: 100%;">Loading map…</div>
          </div>
        {% else %}
          <div class="d-flex align-items-center justify-content-center text-muted small" style="height: 300px;">
            Map information not available.
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Owner Information & Skip Trace -->
  <div class="row g-4 mb-4">
    <div class="col-12 col-lg-6">
      <div class="section-card">
        <div class="section-header">
          <i class="bi bi-person-badge"></i>
          Owner Information
        </div>
        <div class="section-body">
          <div class="data-grid">
            <div class="data-item">
              <div class="data-label">Owner Name</div>
              <div class="data-value">{{ parcel.owner_name|default:"Not available" }}</div>
            </div>
            {% if parcel.owner_name_2 %}
            <div class="data-item">
              <div class="data-label">Co-Owner</div>
              <div class="data-value">{{ parcel.owner_name_2 }}</div>
            </div>
            {% endif %}
            {% if parcel.owner_street %}
            <div class="data-item" style="grid-column: 1 / -1;">
              <div class="data-label">Mailing Address</div>
              <div class="data-value">
                {{ parcel.owner_street }}<br>
                {{ parcel.owner_city }}, {{ parcel.owner_state }} {{ parcel.owner_zip }}
              </div>
            </div>
            {% endif %}
            <div class="data-item">
              <div class="data-label">Occupancy Status</div>
              <div class="data-value">
                <span class="badge {% if parcel.absentee %}bg-warning text-dark{% else %}bg-success{% endif %}">
                  {% if parcel.absentee %}Absentee Owner{% else %}Owner Occupied{% endif %}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="section-card">
        <div class="section-header">
          <i class="bi bi-telephone"></i>
          Skip Trace
        </div>
        <div class="section-body" id="parcel-skiptrace-card">
          {% if skiptrace_allowed %}
            {# Parcel is in a saved list - show skip trace button #}
            <div class="d-flex align-items-center gap-2 mb-3">
              <button type="button"
                      class="btn btn-primary btn-sm"
                      data-role="skiptrace-run"
                      {% if not skiptrace_endpoint %}disabled{% endif %}>
                {{ skiptrace_button_label }}
              </button>
              <div class="spinner-border spinner-border-sm text-primary d-none"
                   data-role="skiptrace-spinner"></div>
            </div>

            <div class="small text-muted mb-3" data-role="skiptrace-status">
              {{ skiptrace_status_message }}
            </div>

            {% if stripe_payment_required and skiptrace_pricing %}
              <div class="alert alert-info small py-2 px-3 mb-3">
                <strong>Cost:</strong> {{ skiptrace_cost_per_lookup_display }} per lookup
              </div>
            {% endif %}

            <div data-role="skiptrace-results" class="{% if not skiptrace_initial %}d-none{% endif %}">
              <table class="table table-sm mb-0">
                <tbody data-role="skiptrace-results-body">
                  {# Results populated by JavaScript #}
                </tbody>
              </table>
            </div>
          {% else %}
            {# Parcel is NOT in a saved list - show info message #}
            <div class="alert alert-warning d-flex align-items-center gap-2 mb-0">
              <i class="bi bi-info-circle"></i>
              <span class="small">
                Add this parcel to a saved list to enable skip trace capabilities.
              </span>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Valuation & Sale History Side by Side -->
  <div class="row g-4 mb-4">
    <div class="col-12 col-lg-6">
      <div class="section-card">
        <div class="section-header">
          <i class="bi bi-cash-stack"></i>
          Valuation
        </div>
        <div class="section-body">
          <div class="data-grid">
            <div class="data-item">
              <div class="data-label">Total Assessed Value</div>
              <div class="data-value" style="font-size: 1.5rem; color: #059669;">
                {% if parcel.total_value %}${{ parcel.total_value|floatformat:0 }}{% else %}N/A{% endif %}
              </div>
            </div>
            <div class="data-item">
              <div class="data-label">Building Value</div>
              <div class="data-value">{% if parcel.building_value %}${{ parcel.building_value|floatformat:0 }}{% else %}N/A{% endif %}</div>
            </div>
            <div class="data-item">
              <div class="data-label">Land Value</div>
              <div class="data-value">{% if parcel.land_value %}${{ parcel.land_value|floatformat:0 }}{% else %}N/A{% endif %}</div>
            </div>
            <div class="data-item">
              <div class="data-label">Equity Percentage</div>
              <div class="data-value">{% if parcel.equity_percent %}{{ parcel.equity_percent|floatformat:1 }}%{% else %}N/A{% endif %}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="section-card">
        <div class="section-header">
          <i class="bi bi-clock-history"></i>
          Sale History
        </div>
        <div class="section-body">
          <div class="data-grid">
            <div class="data-item">
              <div class="data-label">Last Sale Date</div>
              <div class="data-value">{{ parcel.last_sale_date|default:"N/A" }}</div>
            </div>
            <div class="data-item">
              <div class="data-label">Last Sale Price</div>
              <div class="data-value">{% if parcel.last_sale_price %}${{ parcel.last_sale_price|floatformat:0 }}{% else %}N/A{% endif %}</div>
            </div>
            {% for section in sections %}
              {% if section.title == "Sale History" or section.title == "Previous Sales" %}
                {% for label, value in section.items %}
                  <div class="data-item">
                    <div class="data-label">{{ label }}</div>
                    <div class="data-value">{{ value|default:"—" }}</div>
                  </div>
                {% endfor %}
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Property Details -->
  {% for section in sections %}
    {% if section.title != "Skip Trace" and section.title != "Sale History" and section.title != "Previous Sales" %}
    <div class="section-card">
      <div class="section-header">
        <i class="bi bi-info-circle"></i>
        {{ section.title }}
      </div>
      <div class="section-body">
        <div class="data-grid">
          {% for label, value in section.items %}
          <div class="data-item">
            <div class="data-label">{{ label }}</div>
            <div class="data-value">{{ value|default:"—" }}</div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
  {% endfor %}

  <!-- Liens & Legal Actions -->
  {% if liens or legal_actions or lien_search_requested %}
  <div class="section-card mb-4">
    <div class="section-header">
      <i class="bi bi-search"></i>
      Liens & Legal Actions
      <div class="ms-auto">
        <form method="post" action="{% url 'refresh_liens_legal_actions' parcel.town.town_id parcel.loc_id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-light">
            {% if lien_search_requested and lien_search_queued %}
              <span class="spinner-border spinner-border-sm me-1" role="status"></span>Refreshing...
            {% else %}
              <i class="bi bi-arrow-clockwise me-1"></i>Refresh Liens & Cases
            {% endif %}
          </button>
        </form>
      </div>
    </div>

    <div class="section-body">
      <!-- Liens -->
      <h5 class="mb-3"><i class="bi bi-file-earmark-text me-2"></i>Recorded Liens
        {% if liens %}<span class="badge bg-warning text-dark">{{ liens|length }}</span>{% endif %}
      </h5>
      {% if liens %}
      <div class="table-responsive mb-4">
        <table class="data-table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Holder</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody>
            {% for lien in liens %}
            <tr>
              <td><span class="badge bg-secondary">{{ lien.type|default:"Unknown" }}</span></td>
              <td>{{ lien.holder|default:"N/A" }}</td>
              <td>{% if lien.amount %}${{ lien.amount|floatformat:0 }}{% else %}N/A{% endif %}</td>
              <td><span class="badge {% if lien.status == 'Active' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ lien.status|default:"Unknown" }}</span></td>
              <td>{{ lien.recording_date|default:"N/A" }}</td>
              <td><small class="text-muted">{{ lien.source|default:"Manual Entry" }}</small></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-success mb-4">
        <i class="bi bi-check-circle me-2"></i>No liens found
      </div>
      {% endif %}

      <!-- Legal Actions -->
      <h5 class="mb-3"><i class="bi bi-gavel me-2"></i>Legal Actions
        {% if legal_actions %}<span class="badge bg-info">{{ legal_actions|length }}</span>{% endif %}
      </h5>
      {% if legal_actions %}
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Case Number</th>
              <th>Status</th>
              <th>Filed</th>
              <th>Parties</th>
            </tr>
          </thead>
          <tbody>
            {% for action in legal_actions %}
            <tr>
              <td>
                <span class="badge {% if action.action_type == 'foreclosure' %}bg-danger{% elif action.action_type == 'eviction' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                  {{ action.action_type|title }}
                </span>
              </td>
              <td><code>{{ action.case_number }}</code></td>
              <td><span class="badge bg-info">{{ action.status|default:"Unknown" }}</span></td>
              <td>{{ action.filing_date|default:"N/A" }}</td>
              <td>
                <small>
                  <strong>Plaintiff:</strong> {{ action.plaintiff|default:"N/A" }}<br>
                  <strong>Defendant:</strong> {{ action.defendant|default:"N/A" }}
                </small>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-success">
        <i class="bi bi-check-circle me-2"></i>No legal actions found
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Foreclosure & Risk -->
  {% if attom_data %}
  <div class="row g-4 mb-4">
    {% if attom_data.pre_foreclosure %}
    <div class="col-12 col-lg-6">
      <div class="section-card" style="border-left: 4px solid #dc3545;">
        <div class="section-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
          <i class="bi bi-exclamation-triangle"></i>
          Foreclosure Status
          <span class="badge bg-white text-danger ms-auto">ACTIVE</span>
        </div>
        <div class="section-body">
          <div class="data-grid">
            {% if attom_data.foreclosure_stage %}
            <div class="data-item">
              <div class="data-label">Stage</div>
              <div class="data-value">{{ attom_data.foreclosure_stage }}</div>
            </div>
            {% endif %}
            {% if attom_data.foreclosure_recording_date %}
            <div class="data-item">
              <div class="data-label">Recording Date</div>
              <div class="data-value">{{ attom_data.foreclosure_recording_date }}</div>
            </div>
            {% endif %}
            {% if attom_data.foreclosure_auction_date %}
            <div class="data-item">
              <div class="data-label">Auction Date</div>
              <div class="data-value">{{ attom_data.foreclosure_auction_date }}</div>
            </div>
            {% endif %}
            {% if attom_data.foreclosure_default_amount %}
            <div class="data-item">
              <div class="data-label">Default Amount</div>
              <div class="data-value">${{ attom_data.foreclosure_default_amount|floatformat:0 }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if attom_data.default_risk_score is not None %}
    <div class="col-12 {% if attom_data.pre_foreclosure %}col-lg-6{% endif %}">
      <div class="section-card">
        <div class="section-header">
          <i class="bi bi-graph-down"></i>
          Default Risk Score
        </div>
        <div class="section-body">
          <div class="text-center mb-3">
            <div style="font-size: 3rem; font-weight: 700; color: {% if attom_data.default_risk_score >= 70 %}#dc3545{% elif attom_data.default_risk_score >= 40 %}#ffc107{% else %}#28a745{% endif %};">
              {{ attom_data.default_risk_score }}
            </div>
            <div class="text-muted">Risk Score (0-100)</div>
          </div>
          <div class="progress" style="height: 30px; border-radius: 15px;">
            <div class="progress-bar {% if attom_data.default_risk_score >= 70 %}bg-danger{% elif attom_data.default_risk_score >= 40 %}bg-warning{% else %}bg-success{% endif %}"
                 role="progressbar"
                 style="width: {{ attom_data.default_risk_score }}%">
              {{ attom_data.default_risk_score }}%
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Parcel Footprint -->
  {% if parcel_shape and parcel_shape.found and parcel_shape.svg_markup %}
  <div class="row g-4 mb-4">
    <div class="col-12 col-lg-6">
      <div class="section-card">
        <div class="section-header">
          <i class="bi bi-pentagon"></i>
          Parcel Footprint
          {% if parcel_shape.source_hint %}<span class="badge bg-light text-dark ms-auto">{{ parcel_shape.source_hint }}</span>{% endif %}
        </div>
        <div class="section-body">
          <div class="ratio ratio-1x1 border rounded shadow-sm bg-white d-flex align-items-center justify-content-center mb-3">
            {{ parcel_shape.svg_markup|safe }}
          </div>
          <div class="data-grid">
            {% if parcel_shape.area %}
            <div class="data-item">
              <div class="data-label">Area</div>
              <div class="data-value">{{ parcel_shape.area|floatformat:0 }} sqft</div>
            </div>
            {% endif %}
            {% if parcel_shape.width %}
            <div class="data-item">
              <div class="data-label">Width</div>
              <div class="data-value">{{ parcel_shape.width|floatformat:1 }} ft</div>
            </div>
            {% endif %}
            {% if parcel_shape.height %}
            <div class="data-item">
              <div class="data-label">Height</div>
              <div class="data-value">{{ parcel_shape.height|floatformat:1 }} ft</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    {% include "leads/partials/mailer_card.html" with mailer=mailer column_class="col-12 col-lg-6" mailer_generate_endpoint=mailer_generate_endpoint mailer_download_endpoint=mailer_download_endpoint %}
  </div>
  {% elif mailer %}
  <div class="row g-4 mb-4">
    {% include "leads/partials/mailer_card.html" with mailer=mailer column_class="col-12" mailer_generate_endpoint=mailer_generate_endpoint mailer_download_endpoint=mailer_download_endpoint %}
  </div>
  {% endif %}

  <!-- MassGIS Attributes (Collapsible) -->
  <div class="collapsible-section">
    <div class="collapsible-header" onclick="toggleCollapsible('massgis')">
      <div>
        <i class="bi bi-table me-2"></i>
        <strong>MassGIS Attributes</strong>
        <span class="text-muted ms-2">({{ parcel.attributes.items|length }} attributes)</span>
      </div>
      <i class="bi bi-chevron-down chevron" id="massgis-chevron"></i>
    </div>
    <div class="collapsible-body" id="massgis-body">
      <div class="table-responsive">
        <table class="table table-striped table-sm mb-0">
          <tbody>
            {% for key, value in parcel.attributes.items %}
            <tr>
              <th class="text-uppercase small text-muted" style="width: 40%;">{{ key }}</th>
              <td>{{ value|default:"—" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function toggleCollapsible(id) {
      const body = document.getElementById(id + '-body');
      const chevron = document.getElementById(id + '-chevron');
      const header = document.querySelector('.collapsible-header');

      body.classList.toggle('active');
      chevron.classList.toggle('active');
      header.classList.toggle('active');
    }
  </script>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize Street View
      {% if parcel.centroid %}
      const lat = {{ parcel.centroid.0 }};
      const lng = {{ parcel.centroid.1 }};

      const streetViewParams = new URLSearchParams({
        'q': `${lat.toFixed(6)},${lng.toFixed(6)}`,
        'layer': 'c',
        'cbll': `${lat.toFixed(6)},${lng.toFixed(6)}`,
        'll': `${lat.toFixed(6)},${lng.toFixed(6)}`,
        'cbp': '11,0,0,0,0',
        'output': 'svembed'
      });
      document.getElementById('streetViewFrame').src = `https://maps.google.com/maps?${streetViewParams.toString()}`;
      {% endif %}

      // Initialize property map embed
      const mapEl = document.getElementById('parcel-map-embed');
      if (mapEl) {
        const lat = parseFloat(mapEl.dataset.lat);
        const lng = parseFloat(mapEl.dataset.lng);
        if (isNaN(lat) || isNaN(lng)) {
          mapEl.innerHTML = '<div class="d-flex align-items-center justify-content-center text-muted small" style="height: 100%;">Map unavailable for this location.</div>';
        } else {
          const map = L.map(mapEl).setView([lat, lng], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          L.marker([lat, lng]).addTo(map);
        }
      }

      // Initialize mailer card
      const mailerCard = document.getElementById('parcel-mailer-card');
      if (mailerCard) {
        let scriptMap = {};
        try {
          scriptMap = JSON.parse(mailerCard.dataset.scriptMap || '{}');
        } catch (error) {
          console.warn('Mailer scripts could not be parsed', error);
        }

        const select = mailerCard.querySelector('[data-role="mailer-script-select"]');
        const summaryEl = mailerCard.querySelector('[data-role="mailer-summary"]');
        const previewContainer = mailerCard.querySelector('[data-role="mailer-root"]');
        const downloadLink = mailerCard.querySelector('[data-role="mailer-download"]');
        const generateButton = mailerCard.querySelector('[data-role="mailer-generate"]');
        const spinner = mailerCard.querySelector('[data-role="mailer-spinner"]');
        const statusEl = mailerCard.querySelector('[data-role="mailer-status"]');

        if (select && scriptMap) {
          select.addEventListener('change', () => {
            const scriptId = select.value;
            const script = scriptMap[scriptId];
            if (script) {
              summaryEl.textContent = script.summary || 'No summary available';
            } else {
              summaryEl.textContent = '';
            }
          });
        }

        if (generateButton) {
          generateButton.addEventListener('click', () => {
            const scriptId = select ? select.value : '';
            if (!scriptId) {
              alert('Please select a mailer script');
              return;
            }

            spinner.classList.remove('d-none');
            generateButton.disabled = true;
            statusEl.textContent = 'Generating mailer...';

            const endpoint = mailerCard.dataset.generateEndpoint;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
              },
              body: `script_id=${encodeURIComponent(scriptId)}`
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                statusEl.textContent = 'Mailer generated successfully!';
                if (data.html) {
                  previewContainer.innerHTML = data.html;
                }
                if (data.download_url && downloadLink) {
                  downloadLink.href = data.download_url;
                  downloadLink.classList.remove('d-none');
                }
              } else {
                statusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
              }
            })
            .catch(error => {
              statusEl.textContent = 'Error generating mailer';
              console.error('Mailer generation error:', error);
            })
            .finally(() => {
              spinner.classList.add('d-none');
              generateButton.disabled = false;
            });
          });
        }
      }

      // Initialize skip trace
      const skiptraceCard = document.getElementById('parcel-skiptrace-card');
      if (skiptraceCard && window.LeadCRM && window.LeadCRM.skiptrace) {
        try {
          const config = JSON.parse('{{ skiptrace_config_json|escapejs }}');
          window.LeadCRM.skiptrace.init(skiptraceCard, config);
        } catch (error) {
          console.error('Skip trace initialization error:', error);
        }
      }
    });
  </script>
{% endblock %}
