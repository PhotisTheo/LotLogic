{% extends "leads/base.html" %}

{% block title %}{{ saved_list.name }} ‚Äì Saved Parcel List{% endblock %}

{% block content %}
  <div class="page-header mb-4 d-flex flex-wrap justify-content-between align-items-center gap-3">
    <div>
      <h1 class="mb-1">{{ saved_list.name }}</h1>
      <p class="text-muted mb-0">{{ saved_list.town_name }} ¬∑ saved {{ saved_list.created_at|date:"M j, Y H:i" }}</p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'saved_parcel_lists' %}">‚¨Ö All Lists</a>
      <a class="btn btn-outline-primary" href="{% url 'saved_parcel_list_export' saved_list.pk %}">‚¨á Download CSV</a>
      {% if total and not list_is_archived %}
        <button
          type="button"
          class="btn btn-outline-primary"
          data-bs-toggle="modal"
          data-bs-target="#bulkMailerModal"
        >
          üì® Mailers
        </button>
      {% endif %}
      {% if criteria_qs %}
        <a class="btn btn-outline-primary" href="{% url 'parcel_search' %}?{{ criteria_qs }}">üîÅ Re-run Search</a>
      {% endif %}
      <form method="post"
            action="{{ archive_action_endpoint }}"
            class="d-inline">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}">
        {% if list_is_archived %}
          <button type="submit" class="btn btn-outline-success">‚ôª Restore</button>
        {% else %}
          <button type="submit" class="btn btn-outline-danger">üóÇ Archive</button>
        {% endif %}
      </form>
    </div>
  </div>

  {% if list_is_archived %}
    <div class="alert alert-warning d-flex align-items-center gap-2">
      <span class="fw-semibold">Archived</span>
      <span class="text-muted small">This list was archived {{ saved_list.archived_at|date:"M j, Y H:i" }}. Restore to resume skip tracing or updates.</span>
    </div>
  {% endif %}

  {% if parcel_rows %}
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <span class="fw-semibold">{{ total }} parcel{% if total != 1 %}s{% endif %} saved</span>
        {% if list_is_archived %}
          <button type="button" class="btn btn-outline-secondary btn-sm" disabled>Archived</button>
        {% elif bulk_skiptrace_pending_count %}
          <button type="button"
                  class="btn btn-warning btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#bulkSkiptraceModal">
            Skip Trace {{ bulk_skiptrace_pending_count }} Remaining
          </button>
        {% else %}
          <button type="button" class="btn btn-outline-secondary btn-sm" disabled>All Skip Traced</button>
        {% endif %}
      </div>
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Address</th>
              <th>Owner</th>
              <th>Category / Property Type</th>
              <th>Style</th>
              <th>Units</th>
              <th>Absentee</th>
              <th>Skip Trace</th>
              <th>Pre-foreclosure</th>
              <th>Mortgage Default</th>
              <th>Tax Default</th>
              <th>Equity %</th>
              <th>Total Value</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for row in parcel_rows %}
              {% with parcel=row.parcel %}
              <tr>
                <td class="fw-semibold">
                  {{ parcel.site_address|default:"‚Äî" }}
                  <div class="text-muted small">{{ parcel.site_city|default:saved_list.town_name }}{% if parcel.site_zip %} {{ parcel.site_zip }}{% endif %}</div>
                </td>
                <td>{{ parcel.owner_name|default:"‚Äî" }}</td>
                <td>
                  {{ parcel.property_category }}
                  {% if parcel.property_type %}
                    <div class="text-muted small">{{ parcel.property_type }}</div>
                  {% endif %}
                </td>
                <td>{{ parcel.style|default:"‚Äî" }}</td>
                <td>{{ parcel.units|default:"‚Äî" }}</td>
                <td>
                  {% if parcel.absentee %}
                    <span class="badge text-bg-warning text-dark">Absentee</span>
                  {% else %}
                    <span class="badge text-bg-success">Owner</span>
                  {% endif %}
                </td>
                <td>
                  {% if row.skiptraced %}
                    <span class="badge text-bg-success">‚úì Run</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Not Run</span>
                  {% endif %}
                </td>
                <td>
                  {% if parcel.attom_data.pre_foreclosure %}
                      <span class="badge text-bg-danger">Yes</span>
                  {% else %}
                      <span class="badge text-bg-secondary">No</span>
                  {% endif %}
                </td>
                <td>
                  {% if parcel.attom_data.mortgage_default %}
                      <span class="badge text-bg-danger">Yes</span>
                  {% else %}
                      <span class="badge text-bg-secondary">No</span>
                  {% endif %}
                </td>
                <td>
                  {% if parcel.attom_data.tax_default %}
                      <span class="badge text-bg-danger">Yes</span>
                  {% else %}
                      <span class="badge text-bg-secondary">No</span>
                  {% endif %}
                </td>
                <td>{% if parcel.equity_percent is not None %}{{ parcel.equity_percent|floatformat:1 }}%{% else %}‚Äî{% endif %}</td>
                <td>{% if parcel.total_value %}${{ parcel.total_value|floatformat:0 }}{% else %}‚Äî{% endif %}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary me-2" href="{% url 'parcel_detail' town_id=parcel.town.town_id loc_id=parcel.loc_id %}">Details</a>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal fade"
         id="bulkSkiptraceModal"
         tabindex="-1"
         aria-labelledby="bulkSkiptraceModalLabel"
         aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-semibold" id="bulkSkiptraceModalLabel">Confirm Bulk Skip Trace</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="mb-2">
              This will skip trace <strong>{{ bulk_skiptrace_pending_count }}</strong>
              propert{{ bulk_skiptrace_pending_count|pluralize:"y,ies" }}.
            </p>
            <div class="mb-3 d-none" data-role="bulk-skiptrace-card-wrapper">
              <label class="form-label small mb-1" for="bulk-skiptrace-card-element">Card Details</label>
              <div id="bulk-skiptrace-card-element" class="stripe-card-element"></div>
              <div id="bulk-skiptrace-card-error" class="text-danger small mt-2 d-none"></div>
            </div>
            {% if bulk_skiptrace_total_cost_display %}
              <div class="alert alert-warning py-2 mb-3">
                <div class="fw-semibold mb-1">Estimated Total Charge</div>
                <div class="lead mb-0">{{ bulk_skiptrace_total_cost_display }}</div>
                {% if bulk_skiptrace_cost_per_lookup_display %}
                  <div class="small text-muted mb-1">({{ bulk_skiptrace_cost_per_lookup_display }} per property)</div>
                {% endif %}
              </div>
            {% else %}
              <p class="text-warning small mb-3">Set <code>SKIPTRACE_COST_PER_LOOKUP</code> in your environment to show the estimated price.</p>
            {% endif %}
            <div class="d-flex align-items-center gap-2 mt-3">
              <div class="spinner-border spinner-border-sm text-primary d-none" data-role="bulk-skiptrace-spinner" role="status">
                <span class="visually-hidden">Processing‚Ä¶</span>
              </div>
              <div class="small d-none" data-role="bulk-skiptrace-status"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button"
                    class="btn btn-primary"
                    data-role="bulk-skiptrace-confirm"
                    data-endpoint="{{ bulk_skiptrace_endpoint }}"
                    {% if not bulk_skiptrace_pending_count %}disabled{% endif %}>
              {% if bulk_skiptrace_total_cost_display %}
                Confirm &amp; Charge {{ bulk_skiptrace_total_cost_display }}
              {% else %}
                Confirm Skip Trace
              {% endif %}
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade"
         id="bulkMailerModal"
         tabindex="-1"
         aria-labelledby="bulkMailerModalLabel"
         aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-semibold" id="bulkMailerModalLabel">Generate Mailers</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Select the mailer script you'd like to use for all properties in this list. Each option is a ready-to-send letter with consistent formatting.</p>
            <div class="list-group mb-3">
              {% if mailer_script_options %}
                {% for option in mailer_script_options %}
                  <label class="list-group-item list-group-item-action d-flex align-items-start gap-3">
                    <input
                      class="form-check-input mt-1"
                      type="radio"
                      name="bulkMailerScript"
                      value="{{ option.id }}"
                      {% if option.id == mailer_script_selected %}checked{% endif %}
                      required
                    >
                    <span>
                      <span class="fw-semibold d-block">{{ option.label }}</span>
                      {% if option.description %}
                        <span class="text-muted small">{{ option.description }}</span>
                      {% endif %}
                    </span>
                  </label>
                {% endfor %}
              {% else %}
                <div class="alert alert-info mb-0">No mailer scripts are configured.</div>
              {% endif %}
            </div>
            <div class="d-flex align-items-center gap-2 mb-2">
              <div class="spinner-border spinner-border-sm text-primary d-none" data-role="bulk-mailer-spinner" role="status">
                <span class="visually-hidden">Generating‚Ä¶</span>
              </div>
              <div class="text-muted small d-none" data-role="bulk-mailer-status"></div>
            </div>
            <p class="small text-muted mb-0">Mailer generation can take a moment for large lists. We'll start the download automatically when it's ready.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" data-role="bulk-mailer-generate">Generate Mailers</button>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-warning">None of the parcels in this list could be loaded. Try re-running the search to refresh the dataset.</div>
  {% endif %}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) {
        return parts.pop().split(';').shift();
      }
      return null;
    }

    document.addEventListener('DOMContentLoaded', function () {
      const skiptraceModalEl = document.getElementById('bulkSkiptraceModal');
      if (skiptraceModalEl) {
        const confirmButton = skiptraceModalEl.querySelector('[data-role="bulk-skiptrace-confirm"]');
        const skiptraceSpinner = skiptraceModalEl.querySelector('[data-role="bulk-skiptrace-spinner"]');
        const skiptraceStatus = skiptraceModalEl.querySelector('[data-role="bulk-skiptrace-status"]');
        const cardWrapper = skiptraceModalEl.querySelector('[data-role="bulk-skiptrace-card-wrapper"]');
        const paymentConfigTemplate = {{ bulk_skiptrace_payment_config_json|safe }};
        const paymentModule = window.LeadCRM && window.LeadCRM.payment;

        const setSkiptraceStatus = (message, tone) => {
          if (!skiptraceStatus) {
            return;
          }
          skiptraceStatus.textContent = message || '';
          skiptraceStatus.classList.add('small');
          skiptraceStatus.classList.remove('d-none', 'text-danger', 'text-success', 'text-muted');
          if (!message) {
            skiptraceStatus.classList.add('d-none');
            return;
          }
          if (tone === 'error') {
            skiptraceStatus.classList.add('text-danger');
          } else if (tone === 'success') {
            skiptraceStatus.classList.add('text-success');
          } else {
            skiptraceStatus.classList.add('text-muted');
          }
        };

        skiptraceModalEl.addEventListener('show.bs.modal', function () {
          setSkiptraceStatus('', null);
          if (skiptraceSpinner) {
            skiptraceSpinner.classList.add('d-none');
          }
          if (confirmButton) {
            confirmButton.disabled = false;
          }
          if (cardWrapper) {
            if (paymentConfigTemplate && paymentConfigTemplate.enabled && paymentModule && paymentModule.isReady()) {
              cardWrapper.classList.remove('d-none');
              paymentModule.mount(paymentConfigTemplate);
              paymentModule.setError(paymentConfigTemplate, '');
            } else {
              cardWrapper.classList.add('d-none');
            }
          }
        });

        if (confirmButton) {
          confirmButton.addEventListener('click', async function () {
            const endpoint = confirmButton.dataset.endpoint;
            if (!endpoint) {
              setSkiptraceStatus('Bulk skip trace endpoint is not available.', 'error');
              return;
            }

            confirmButton.disabled = true;
            let paymentConfig = null;
            if (paymentConfigTemplate) {
              paymentConfig = Object.assign({}, paymentConfigTemplate, {
                intentPayload: Object.assign({}, paymentConfigTemplate.intentPayload || {}),
              });
            }

            if (skiptraceSpinner) {
              skiptraceSpinner.classList.remove('d-none');
            }
            setSkiptraceStatus('Processing payment‚Ä¶', 'pending');

            try {
              if (paymentConfig && paymentConfig.enabled && paymentModule && paymentModule.isReady()) {
                const paid = await paymentModule.process(paymentConfig);
                if (!paid) {
                  confirmButton.disabled = false;
                  if (skiptraceSpinner) {
                    skiptraceSpinner.classList.add('d-none');
                  }
                  setSkiptraceStatus('Payment could not be completed. Please update your card details.', 'error');
                  return;
                }
              }

              setSkiptraceStatus('Running skip trace‚Ä¶', 'pending');
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCookie('csrftoken') || ''
                },
                body: JSON.stringify({})
              });
              let payload = {};
              try {
                payload = await response.json();
              } catch (error) {
                payload = {};
              }

              if (!response.ok || (payload && payload.error)) {
                throw new Error((payload && payload.error) || 'Bulk skip trace failed.');
              }

              if (payload.message) {
                setSkiptraceStatus(payload.message, 'success');
              } else {
                setSkiptraceStatus('Skip trace completed.', 'success');
              }

              setTimeout(() => {
                window.location.reload();
              }, 800);
            } catch (error) {
              setSkiptraceStatus(error.message || 'Unable to run bulk skip trace.', 'error');
              confirmButton.disabled = false;
            } finally {
              if (skiptraceSpinner) {
                skiptraceSpinner.classList.add('d-none');
              }
              if (confirmButton) {
                confirmButton.disabled = false;
              }
            }
          });
        }
      }

      const mailerModalEl = document.getElementById('bulkMailerModal');
      if (mailerModalEl) {
        const generateButton = mailerModalEl.querySelector('[data-role="bulk-mailer-generate"]');
        const mailerSpinner = mailerModalEl.querySelector('[data-role="bulk-mailer-spinner"]');
        const mailerStatus = mailerModalEl.querySelector('[data-role="bulk-mailer-status"]');

        const showMailerStatus = (message, tone) => {
          if (!mailerStatus) {
            return;
          }
          mailerStatus.textContent = message || '';
          mailerStatus.classList.remove('d-none', 'text-danger', 'text-success', 'text-muted');
          mailerStatus.classList.add('small');
          if (!message) {
            mailerStatus.classList.add('d-none');
            return;
          }
          if (tone === 'error') {
            mailerStatus.classList.add('text-danger');
          } else if (tone === 'success') {
            mailerStatus.classList.add('text-success');
          } else {
            mailerStatus.classList.add('text-muted');
          }
        };

        const toggleMailerSpinner = (show) => {
          if (!mailerSpinner) {
            return;
          }
          mailerSpinner.classList.toggle('d-none', !show);
        };

        const getSelectedScript = () => {
          const radios = mailerModalEl.querySelectorAll('input[name="bulkMailerScript"]');
          for (const radio of radios) {
            if (radio.checked) {
              return radio.value;
            }
          }
          return null;
        };

        const downloadFileBlob = (blob, filenameFallback) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filenameFallback || 'mailers.pdf';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        };
        const parseFilename = (contentDisposition) => {
          if (!contentDisposition) {
            return null;
          }
          const filenameStarMatch = contentDisposition.match(/filename\*\s*=\s*(?:UTF-8''|)([^;]+)/i);
          if (filenameStarMatch && filenameStarMatch[1]) {
            try {
              return decodeURIComponent(filenameStarMatch[1].replace(/["']/g, '').trim());
            } catch (err) {
              return filenameStarMatch[1].replace(/["']/g, '').trim();
            }
          }
          const filenameMatch = contentDisposition.match(/filename\s*=\s*("?)([^";]+)\1/);
          if (filenameMatch && filenameMatch[2]) {
            return filenameMatch[2].trim();
          }
          return null;
        };

        mailerModalEl.addEventListener('show.bs.modal', () => {
          showMailerStatus('', null);
          toggleMailerSpinner(false);
          if (generateButton) {
            generateButton.disabled = false;
          }
        });

        if (generateButton) {
          generateButton.addEventListener('click', async () => {
            if (generateButton.disabled) {
              return;
            }

            const scriptId = getSelectedScript();
            if (!scriptId) {
              showMailerStatus('Select a template to continue.', 'error');
              return;
            }

            generateButton.disabled = true;
            showMailerStatus('Generating mailers‚Ä¶', 'info');
            toggleMailerSpinner(true);

            try {
              const csrfToken = getCookie('csrftoken');
              const response = await fetch('{{ saved_list_mailer_endpoint }}', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                  ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}),
                },
                body: new URLSearchParams({ script_id: scriptId }).toString(),
              });

              const contentType = response.headers.get('content-type') || '';
              if (!response.ok) {
                if (contentType.includes('application/json')) {
                  const errorData = await response.json().catch(() => ({}));
                  const errorMessage = errorData.error || 'Mailer generation failed.';
                  throw new Error(errorMessage);
                }
                throw new Error('Mailer generation failed.');
              }

              if (contentType.includes('application/json')) {
                const data = await response.json().catch(() => ({}));
                throw new Error((data && data.error) || 'Mailer generation failed.');
              }

              const blob = await response.blob();
              const disposition = response.headers.get('content-disposition');
              const filename = parseFilename(disposition) || `mailers-${Date.now()}.html`;
              downloadFileBlob(blob, filename);
              const generated = response.headers.get('x-mailers-generated');
              const reused = response.headers.get('x-mailers-reused');
              const skipped = response.headers.get('x-mailers-skipped');
              const summaryParts = [];
              if (generated) {
                summaryParts.push(`${generated} generated`);
              }
              if (reused && reused !== '0') {
                summaryParts.push(`${reused} reused`);
              }
              if (skipped && skipped !== '0') {
                summaryParts.push(`${skipped} skipped`);
              }
              const summaryText = summaryParts.length ? ` (${summaryParts.join(', ')})` : '';
              showMailerStatus(`Mailers ready! Download should begin automatically${summaryText}.`, 'success');
              setTimeout(() => {
                const modalInstance = bootstrap.Modal.getInstance(mailerModalEl);
                if (modalInstance) {
                  modalInstance.hide();
                }
              }, 1200);
            } catch (error) {
              showMailerStatus(error.message || 'Unable to generate mailers.', 'error');
            } finally {
              generateButton.disabled = false;
              toggleMailerSpinner(false);
            }
          });
        }
      }
    });

  </script>
{% endblock %}
