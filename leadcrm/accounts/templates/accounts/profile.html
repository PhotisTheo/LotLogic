{% extends "leads/base.html" %}

{% block title %}Profile · Lead CRM{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-8">
    <div class="card shadow-sm mb-4">
      <div class="card-body p-4 p-md-5">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
          <div>
            <h1 class="h3 fw-semibold mb-1">{{ request.user.get_full_name|default:request.user.username }}</h1>
            <div class="text-muted">Signed in as <strong>{{ request.user.username }}</strong> · {{ request.user.email|default:"no email on file" }}</div>
            <div class="mt-2 d-flex flex-wrap gap-2">
              <span class="badge bg-secondary-subtle text-secondary-emphasis px-3 py-2 fw-semibold">
                {% if profile.account_type == "team_lead" %}
                  Team Lead
                {% elif profile.account_type == "team_member" %}
                  Team Member ({{ profile.team_lead.get_full_name|default:profile.team_lead.username }})
                {% else %}
                  Individual Workspace
                {% endif %}
              </span>
              <span class="badge bg-primary-subtle text-primary-emphasis px-3 py-2 fw-semibold">{{ plan_details.label }} · {{ plan_details.price_display }}</span>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-3 mt-md-0">
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="profileMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileMenuButton">
                <li>
                  <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#updateDetailsModal">
                    <i class="bi bi-pencil"></i> Update Details
                  </button>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item" href="{% url 'accounts:settings' %}">
                    <i class="bi bi-gear"></i> Settings
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="post" action="{% url 'accounts:logout' %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="dropdown-item text-danger">
                      <i class="bi bi-box-arrow-right"></i> Log Out
                    </button>
                  </form>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="border rounded-4 p-4 h-100 bg-light-subtle">
              <div class="text-muted text-uppercase small fw-semibold mb-2">Workspace identity</div>
              <div class="fw-semibold">{{ profile.company_name|default:"Add your company" }}</div>
              <div class="text-muted small mt-2">
                <span class="d-block">{{ profile.job_title|default:"Role not set" }}</span>
                {% if profile.work_phone %}
                  <span class="d-block">Work: {{ profile.work_phone }}</span>
                {% endif %}
                {% if profile.mobile_phone %}
                  <span class="d-block">Mobile: {{ profile.mobile_phone }}</span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="border rounded-4 p-4 h-100 bg-white">
              <div class="text-muted text-uppercase small fw-semibold mb-2">About</div>
              {% if profile.bio %}
                <p class="mb-0 text-muted">{{ profile.bio }}</p>
              {% else %}
                <p class="mb-0 text-muted">Share a short intro so teammates know how you work leads.</p>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <div class="border rounded-4 p-4 h-100 bg-light-subtle">
              <div class="text-muted text-uppercase small fw-semibold mb-2">Saved Lists</div>
              <div class="display-6 fw-semibold mb-1">{{ saved_list_count }}</div>
              <p class="mb-0 text-muted small">Parcel lists you've captured from MassGIS searches.</p>
              <a class="small fw-semibold mt-2 d-inline-block" href="{% url 'saved_parcel_lists' %}">View all lists →</a>
            </div>
          </div>
          <div class="col-md-6">
            <div class="border rounded-4 p-4 h-100 bg-light-subtle">
              <div class="text-muted text-uppercase small fw-semibold mb-2">CRM Leads</div>
              <div class="display-6 fw-semibold mb-1">{{ active_lead_count }}</div>
              <p class="mb-0 text-muted small">Prospects you're tracking and nurturing through the CRM.</p>
              <a class="small fw-semibold mt-2 d-inline-block" href="{% url 'crm_overview' %}">Open CRM dashboard →</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body p-4 p-md-5">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
          <div>
            <h2 class="h5 fw-semibold mb-1">Generate Mailers</h2>
            <p class="text-muted mb-0">Download personalized letters for any saved list in your workspace.</p>
            {% if custom_mailer_template_count %}
              <p class="small text-muted mb-0 mt-2">
                Custom templates available: {{ custom_mailer_template_count }}.
                <a href="{% url 'accounts:mailer_templates' %}">Manage templates</a>
              </p>
            {% endif %}
          </div>
          <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-outline-secondary" href="{% url 'saved_parcel_lists' %}">Manage saved lists</a>
            <a class="btn btn-outline-primary" href="{% url 'accounts:mailer_templates' %}">Manage templates</a>
          </div>
        </div>
        {% if mailer_saved_lists %}
          {% if mailer_script_options %}
            {% with initial_list=mailer_saved_lists|first %}
              {% if initial_list %}
                <div id="profileMailerPanel" data-role="profile-mailer-panel">
                  <div class="row g-4 align-items-stretch">
                    <div class="col-lg-5">
                      <label class="form-label fw-semibold" for="profileMailerListSelect">Saved list</label>
                      <select class="form-select" id="profileMailerListSelect" data-role="profile-mailer-list-select">
                        {% for saved_list in mailer_saved_lists %}
                          <option
                            value="{{ saved_list.id }}"
                            data-endpoint="{{ saved_list.endpoint }}"
                            data-name="{{ saved_list.name }}"
                            data-town="{{ saved_list.town_name }}"
                            data-parcel-count="{{ saved_list.parcel_count }}"
                            {% if saved_list.id == initial_list.id %}selected{% endif %}
                          >
                            {{ saved_list.name }} · {{ saved_list.town_name }} ({{ saved_list.parcel_count }} parcel{{ saved_list.parcel_count|pluralize }})
                          </option>
                        {% endfor %}
                      </select>
                      <div class="text-muted small mt-2" data-role="profile-mailer-list-summary">
                        {{ initial_list.name }} in {{ initial_list.town_name }} · {{ initial_list.parcel_count }} parcel{{ initial_list.parcel_count|pluralize }}
                      </div>
                    </div>
                    <div class="col-lg-7">
                      <div class="border rounded-4 p-3 bg-light-subtle h-100">
                        <div class="text-uppercase text-muted fw-semibold small mb-2">Letter template</div>
                        <div class="list-group" data-role="profile-mailer-script-options">
                          {% for option in mailer_script_options %}
                            <label class="list-group-item list-group-item-action d-flex align-items-start gap-3">
                              <input
                                class="form-check-input mt-1"
                                type="radio"
                                name="profileMailerScript"
                                value="{{ option.id }}"
                                {% if option.id == mailer_default_script %}checked{% endif %}
                                required
                              >
                              <span>
                                <span class="fw-semibold d-block">{{ option.label }}</span>
                                {% if option.description %}
                                  <span class="text-muted small">{{ option.description }}</span>
                                {% endif %}
                              </span>
                            </label>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mt-4">
                    <label class="form-label fw-semibold">Also Generate Mailing Labels (Optional)</label>
                    <select class="form-select" id="profileLabelFormatSelect" name="label_format" style="max-width: 500px;">
                      <option value="">Don't generate labels</option>
                      <option value="5160" selected>Avery 5160 - Address Labels (30 per sheet, 1" × 2⅝")</option>
                      <option value="5163">Avery 5163 - Shipping Labels (10 per sheet, 2" × 4")</option>
                      <option value="5167">Avery 5167 - Return Address Labels (80 per sheet, ½" × 1¾")</option>
                    </select>
                    <div class="form-text">
                      Labels will be downloaded as a separate PDF formatted for standard label sheets.
                    </div>
                  </div>
                  <div class="d-flex align-items-center flex-wrap gap-3 mt-4">
                    <button type="button" class="btn btn-primary" data-role="profile-mailer-generate">Download Mailers</button>
                    <div class="spinner-border spinner-border-sm text-primary d-none" role="status" data-role="profile-mailer-spinner">
                      <span class="visually-hidden">Generating…</span>
                    </div>
                    <div class="small text-muted d-none" data-role="profile-mailer-status"></div>
                  </div>
                  <p class="small text-muted mb-0 mt-2">We'll generate one letter per parcel and start the download automatically.</p>
                </div>
              {% endif %}
            {% endwith %}
          {% else %}
            <div class="alert alert-warning mb-0">
              Mailer templates are not configured yet. Please contact support if this seems incorrect.
            </div>
          {% endif %}
        {% else %}
          <div class="alert alert-info mb-0">
            Save a parcel list first to generate mailers.
            <a href="{% url 'saved_parcel_lists' %}" class="alert-link">Create a saved list</a>.
          </div>
        {% endif %}
      </div>
    </div>



    {% if profile.account_type == "team_lead" %}
      <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
          <h2 class="h5 fw-semibold mb-3">Team management</h2>
          <div class="text-muted small mb-3">
            Plan: <strong>{{ plan_details.label }}</strong> · {{ plan_details.price_display }} &middot; Seats included: {{ profile.team_member_limit }}.
            {% if plan_details.upgrade_note %}
              <div class="mt-1">{{ plan_details.upgrade_note }}</div>
            {% endif %}
          </div>
          <p class="text-muted small mb-4">
            You have {{ remaining_invites }} invite{{ remaining_invites|pluralize }} remaining.
          </p>
          {% if last_invite_url %}
            <div class="alert alert-success d-flex align-items-start">
              <div>
                <div class="fw-semibold mb-1">Invite link created!</div>
                <code class="d-block small text-break">{{ last_invite_url }}</code>
                <div class="small text-muted mt-1">Share this link with your teammate so they can sign up directly.</div>
                {% if last_invite_accept_url %}
                  <div class="small text-muted mt-2">Already have an account? Send them this join link instead:</div>
                  <code class="d-block small text-break">{{ last_invite_accept_url }}</code>
                {% endif %}
              </div>
            </div>
          {% endif %}
          <form method="post" action="{% url 'accounts:team_invite_create' %}" class="row g-2 mb-4">
            {% csrf_token %}
            <div class="col-md-8">
              {{ invite_form.email }}
              {% for error in invite_form.email.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4 d-grid">
              <button type="submit" class="btn btn-primary" {% if remaining_invites == 0 %}disabled{% endif %}>
                Send Invite
              </button>
            </div>
          </form>
          <div class="row">
            <div class="col-md-6">
              <h3 class="h6 text-uppercase text-muted fw-semibold mb-2">Active teammates</h3>
              {% if team_members %}
                <ul class="list-group list-group-flush">
                  {% for member in team_members %}
                    <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                      <span>{{ member.user.get_full_name|default:member.user.username }}</span>
                      <span class="badge bg-success-subtle text-success-emphasis">Active</span>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="small text-muted mb-0">No teammates yet. Send an invite to get started.</p>
              {% endif %}
            </div>
            <div class="col-md-6 mt-4 mt-md-0">
              <h3 class="h6 text-uppercase text-muted fw-semibold mb-2">Pending invites</h3>
              {% if pending_invites %}
                <ul class="list-group list-group-flush">
                  {% for invite in pending_invites %}
                    <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                      <span>{{ invite.email }}</span>
                      <span class="small text-muted">{{ invite.created_at|date:"M j, Y" }}</span>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="small text-muted mb-0">No pending invites.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% elif profile.account_type == "team_member" %}
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h2 class="h6 text-uppercase text-muted fw-semibold mb-3">Team roster</h2>
          {% if team_members %}
            <ul class="list-group list-group-flush">
              {% for member in team_members %}
                <li class="list-group-item px-0">
                  {{ member.user.get_full_name|default:member.user.username }}
                  {% if member.user == profile.team_lead %}
                    <span class="badge bg-primary-subtle text-primary-emphasis ms-2">Team Lead</span>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="small text-muted mb-0">Team roster information is currently unavailable.</p>
          {% endif %}
        </div>
      </div>
    {% endif %}
</div>
</div>

<!-- Update Details Modal -->
<div class="modal fade" id="updateDetailsModal" tabindex="-1" aria-labelledby="updateDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-semibold" id="updateDetailsModalLabel">Update Your Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'accounts:profile' %}" novalidate>
        <div class="modal-body">
          {% csrf_token %}
          {% if profile_form.non_field_errors %}
            <div class="alert alert-danger">
              {% for error in profile_form.non_field_errors %}
                <div>{{ error }}</div>
              {% endfor %}
            </div>
          {% endif %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold" for="{{ profile_form.first_name.id_for_label }}">First name</label>
              {{ profile_form.first_name }}
              {% for error in profile_form.first_name.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold" for="{{ profile_form.last_name.id_for_label }}">Last name</label>
              {{ profile_form.last_name }}
              {% for error in profile_form.last_name.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold" for="{{ profile_form.company_name.id_for_label }}">Company</label>
              {{ profile_form.company_name }}
              {% for error in profile_form.company_name.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold" for="{{ profile_form.job_title.id_for_label }}">Role</label>
              {{ profile_form.job_title }}
              {% for error in profile_form.job_title.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold" for="{{ profile_form.work_phone.id_for_label }}">Work phone</label>
              {{ profile_form.work_phone }}
              {% for error in profile_form.work_phone.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold" for="{{ profile_form.mobile_phone.id_for_label }}">Mobile</label>
              {{ profile_form.mobile_phone }}
              {% for error in profile_form.mobile_phone.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold" for="{{ profile_form.bio.id_for_label }}">About you</label>
              {{ profile_form.bio }}
              {% for error in profile_form.bio.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    // Auto-open modal if there are form errors
    document.addEventListener('DOMContentLoaded', function () {
      {% if profile_form.errors %}
        const updateDetailsModal = new bootstrap.Modal(document.getElementById('updateDetailsModal'));
        updateDetailsModal.show();
      {% endif %}
    });

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) {
        return parts.pop().split(';').shift();
      }
      return null;
    }

    document.addEventListener('DOMContentLoaded', function () {
      const panel = document.querySelector('[data-role="profile-mailer-panel"]');
      if (!panel) {
        return;
      }

      const listSelect = panel.querySelector('[data-role="profile-mailer-list-select"]');
      const generateButton = panel.querySelector('[data-role="profile-mailer-generate"]');
      const spinner = panel.querySelector('[data-role="profile-mailer-spinner"]');
      const statusEl = panel.querySelector('[data-role="profile-mailer-status"]');
      const summaryEl = panel.querySelector('[data-role="profile-mailer-list-summary"]');

      const showStatus = (message, tone) => {
        if (!statusEl) {
          return;
        }
        statusEl.textContent = message || '';
        statusEl.classList.remove('d-none', 'text-danger', 'text-success', 'text-muted');
        if (!message) {
          statusEl.classList.add('d-none');
          return;
        }
        statusEl.classList.add('text-muted');
        if (tone === 'error') {
          statusEl.classList.replace('text-muted', 'text-danger');
        } else if (tone === 'success') {
          statusEl.classList.replace('text-muted', 'text-success');
        }
      };

      const toggleSpinner = (show) => {
        if (!spinner) {
          return;
        }
        spinner.classList.toggle('d-none', !show);
      };

      const getSelectedScript = () => {
        const radios = panel.querySelectorAll('input[name="profileMailerScript"]');
        for (const radio of radios) {
          if (radio.checked) {
            return radio.value;
          }
        }
        return null;
      };

      const downloadBlob = (blob, filenameFallback) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filenameFallback || 'mailers.html';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const parseFilename = (contentDisposition) => {
        if (!contentDisposition) {
          return null;
        }
        const filenameStarMatch = contentDisposition.match(/filename\*\s*=\s*(?:UTF-8''|)([^;]+)/i);
        if (filenameStarMatch && filenameStarMatch[1]) {
          try {
            return decodeURIComponent(filenameStarMatch[1].replace(/["']/g, '').trim());
          } catch (err) {
            return filenameStarMatch[1].replace(/["']/g, '').trim();
          }
        }
        const filenameMatch = contentDisposition.match(/filename\s*=\s*("?)([^";]+)\1/);
        if (filenameMatch && filenameMatch[2]) {
          return filenameMatch[2].trim();
        }
        return null;
      };

      const updateListSummary = () => {
        if (!summaryEl || !listSelect) {
          return;
        }
        const selectedOption = listSelect.options[listSelect.selectedIndex];
        if (!selectedOption) {
          summaryEl.textContent = '';
          summaryEl.classList.add('d-none');
          return;
        }
        const name = selectedOption.dataset.name || selectedOption.textContent.trim();
        const town = selectedOption.dataset.town || '';
        const parcelCountRaw = selectedOption.dataset.parcelCount || '0';
        const parcelCount = Number.parseInt(parcelCountRaw, 10);
        const safeCount = Number.isNaN(parcelCount) ? 0 : parcelCount;
        const parcelLabel = safeCount === 1 ? '1 parcel' : `${safeCount} parcels`;
        const townPart = town ? ` in ${town}` : '';
        summaryEl.textContent = `${name}${townPart} · ${parcelLabel}`;
        summaryEl.classList.remove('d-none');
      };

      if (listSelect) {
        listSelect.addEventListener('change', () => {
          updateListSummary();
          showStatus('', null);
        });
        updateListSummary();
      }

      if (generateButton) {
        generateButton.addEventListener('click', async () => {
          if (!listSelect) {
            return;
          }
          const selectedOption = listSelect.options[listSelect.selectedIndex];
          if (!selectedOption) {
            showStatus('Select a saved list to continue.', 'error');
            return;
          }
          const endpoint = selectedOption.dataset.endpoint;
          if (!endpoint) {
            showStatus('Unable to determine the mailer endpoint for this list.', 'error');
            return;
          }

          const scriptId = getSelectedScript();
          if (!scriptId) {
            showStatus('Choose a letter template before generating mailers.', 'error');
            return;
          }

          generateButton.disabled = true;
          showStatus('Generating mailers…', 'info');
          toggleSpinner(true);

          try {
            const csrfToken = getCookie('csrftoken');
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}),
              },
              body: new URLSearchParams({ script_id: scriptId }).toString(),
            });

            const contentType = response.headers.get('content-type') || '';
            if (!response.ok) {
              if (contentType.includes('application/json')) {
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.error || 'Mailer generation failed.';
                throw new Error(errorMessage);
              }
              throw new Error('Mailer generation failed.');
            }

            if (contentType.includes('application/json')) {
              const data = await response.json().catch(() => ({}));
              throw new Error((data && data.error) || 'Mailer generation failed.');
            }

            const blob = await response.blob();
            const disposition = response.headers.get('content-disposition');
            const filename = parseFilename(disposition) || `mailers-${Date.now()}.html`;
            downloadBlob(blob, filename);

            const generated = response.headers.get('x-mailers-generated');
            const reused = response.headers.get('x-mailers-reused');
            const skipped = response.headers.get('x-mailers-skipped');
            const summaryParts = [];
            if (generated) {
              summaryParts.push(`${generated} generated`);
            }
            if (reused && reused !== '0') {
              summaryParts.push(`${reused} reused`);
            }
            if (skipped && skipped !== '0') {
              summaryParts.push(`${skipped} skipped`);
            }
            const summaryText = summaryParts.length ? ` (${summaryParts.join(', ')})` : '';
            showStatus(`Mailers ready! Download should begin automatically${summaryText}.`, 'success');

            // Also generate labels if format is selected
            const labelFormatSelect = document.getElementById('profileLabelFormatSelect');
            const labelFormat = labelFormatSelect ? labelFormatSelect.value : '';

            if (labelFormat) {
              try {
                showStatus('Also generating labels...', 'info');
                const savedListId = selectedOption.value;
                const labelEndpoint = `/saved-lists/${savedListId}/labels/`;

                const labelFormData = new FormData();
                labelFormData.append('label_format', labelFormat);
                labelFormData.append('csrfmiddlewaretoken', csrfToken || '');

                const labelResponse = await fetch(labelEndpoint, {
                  method: 'POST',
                  body: labelFormData
                });

                if (labelResponse.ok) {
                  const labelBlob = await labelResponse.blob();
                  const labelDisposition = labelResponse.headers.get('content-disposition');
                  const labelFilename = parseFilename(labelDisposition) || `labels-${Date.now()}.pdf`;
                  downloadBlob(labelBlob, labelFilename);
                  showStatus('Mailers and labels downloaded successfully!', 'success');
                }
              } catch (labelError) {
                console.error('Label generation failed:', labelError);
                showStatus('Mailers downloaded. Labels failed to generate.', 'error');
              }
            }
          } catch (error) {
            showStatus(error.message || 'Unable to generate mailers.', 'error');
          } finally {
            generateButton.disabled = false;
            toggleSpinner(false);
          }
        });
      }
    });
  </script>
{% endblock %}
