{% extends "leads/base.html" %}

{% block title %}Parcel ‚Äì {{ parcel.site_address|default:parcel.loc_id }}{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
{% endblock %}

{% block content %}
  <div class="page-header mb-4">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
      <div>
        <div class="text-uppercase text-muted small">MassGIS Parcel</div>
        <h1 class="mb-1">{{ parcel.site_address|default:parcel.loc_id }}</h1>
        <div class="text-muted">{{ parcel.site_city|default:parcel.town.name }}{% if parcel.site_zip %} ¬∑ {{ parcel.site_zip }}{% endif %}</div>
      </div>
      <div class="text-md-end">
        <div class="stat-pill mb-2">{{ parcel.property_category }}</div>
        <span class="badge {% if parcel.absentee %}text-bg-warning text-dark{% else %}text-bg-success{% endif %}">
          {% if parcel.absentee %}Absentee Owner{% else %}Owner Occupied{% endif %}
        </span>
      </div>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 mb-4">
    {% if from_list %}
      <a class="btn btn-outline-secondary btn-sm" href="{{ list_url }}">‚¨Ö Back to {{ list_name }}</a>
    {% else %}
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'parcel_search' %}">‚¨Ö Back to Search</a>
    {% endif %}
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'saved_parcel_lists' %}">üìÅ Saved Lists</a>
    <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#savePropertyModal">
      <i class="bi bi-bookmark-plus"></i> Save Property
    </button>
    {% if zillow_url %}
      <a class="btn btn-outline-primary btn-sm" href="{{ zillow_url }}" target="_blank" rel="noopener">View on Zillow</a>
    {% endif %}

    {% if from_list %}
      <div class="ms-auto d-flex gap-2 align-items-center">
        <span class="text-muted small">{{ current_index|add:1 }} of {{ total_parcels }}</span>
        {% if prev_parcel %}
          <a class="btn btn-outline-secondary btn-sm" href="{{ prev_parcel.url }}" id="prevParcelBtn" title="Previous parcel (Left Arrow)">
            ‚Üê Previous
          </a>
        {% else %}
          <button class="btn btn-outline-secondary btn-sm" disabled title="No previous parcel">
            ‚Üê Previous
          </button>
        {% endif %}
        {% if next_parcel %}
          <a class="btn btn-outline-secondary btn-sm" href="{{ next_parcel.url }}" id="nextParcelBtn" title="Next parcel (Right Arrow)">
            Next ‚Üí
          </a>
        {% else %}
          <button class="btn btn-outline-secondary btn-sm" disabled title="No next parcel">
            Next ‚Üí
          </button>
        {% endif %}
      </div>
    {% endif %}
  </div>

  {% if property_summary %}
    <div class="card shadow-sm mb-4">
      <div class="card-header fw-semibold">
        <i class="fa-solid fa-wand-magic-sparkles me-2"></i>AI Property Summary
      </div>
      <div class="card-body">
        <p class="card-text">{{ property_summary }}</p>
      </div>
    </div>
  {% endif %}

  {# PROPERTY PREVIEW - Full Width at Top with Overlay #}
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="card h-100">
        <div class="card-body p-0 position-relative">
          {% if property_embed_url %}
            <div class="ratio ratio-16x9">
              <iframe src="{{ property_embed_url }}" width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy"></iframe>
            </div>
          {% elif google_maps and google_maps.lat and google_maps.lng %}
            <div class="ratio ratio-16x9" id="parcel-map-embed"
                 data-lat="{{ google_maps.lat }}"
                 data-lng="{{ google_maps.lng }}">
              <div class="d-flex align-items-center justify-content-center text-muted small">Loading map‚Ä¶</div>
            </div>
          {% else %}
            <div class="ratio ratio-16x9 bg-light d-flex align-items-center justify-content-center text-muted small">
              Map information not available.
            </div>
          {% endif %}

          {# Overlay with Property Info #}
          <div class="position-absolute bottom-0 start-0 end-0 p-3" style="background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.7) 70%, transparent 100%);">
            <div class="row g-3 text-white">
              <div class="col-12 col-md-6">
                <div class="d-flex flex-wrap gap-3">
                  {% for section in sections %}
                    {% if section.title == "Property Overview" %}
                      {% for label, value in section.items %}
                        {% if value %}
                        <div class="text-shadow">
                          <div class="text-white-50 small">{{ label }}</div>
                          <div class="fw-semibold">{{ value }}</div>
                        </div>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
              <div class="col-12 col-md-6">
                <div class="d-flex flex-wrap gap-3">
                  {% for section in sections %}
                    {% if section.title == "Location" %}
                      {% for label, value in section.items %}
                        {% if value %}
                        <div class="text-shadow">
                          <div class="text-white-50 small">{{ label }}</div>
                          <div class="fw-semibold">{{ value }}</div>
                        </div>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if units_detail and units_detail|length > 1 %}
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
      <span>Individual Units ({{ units_detail|length }})</span>
      <span class="text-muted small">Includes condo/unit records attached to this parcel</span>
    </div>
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 10%;">Unit</th>
            <th style="width: 20%;">Owner</th>
            <th>Mailing Address</th>
            <th style="width: 15%;">Notes</th>
          </tr>
        </thead>
        <tbody>
          {% for unit in units_detail %}
          <tr
            data-role="unit-row"
            data-unit-key="{{ unit.row_key }}"
            data-unit-loc="{{ unit.loc_id|default:'' }}"
            data-unit-total="{{ unit.total_value|default_if_none:'' }}"
            class="{% if unit.is_master_record %}table-warning{% endif %}{% if unit.row_key == unit_default_key %} table-active{% endif %}"
            role="button"
            tabindex="0"
            style="cursor: pointer;"
          >
            <td>{{ unit.unit_number|default:"‚Äî" }}</td>
            <td>{{ unit.owner|default:"‚Äî" }}</td>
            <td>{{ unit.mailing_address|default:"‚Äî" }}</td>
            <td>
              {% if unit.is_master_record %}
                <span class="badge text-bg-secondary">Master</span>
              {% elif unit.site_address %}
                {{ unit.site_address }}
              {% else %}
                ‚Äî
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
  {{ units_detail|json_script:"parcel-units-data" }}
  <span id="parcel-metadata" data-parcel-loc="{{ parcel.loc_id|default_if_none:'' }}" hidden></span>

  <style>
    .text-shadow {
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }
    .bi-chevron-down {
      transition: transform 0.3s ease;
    }
  </style>

  {# OWNER INFO & SKIP TRACE - Side by Side #}
  <div class="row g-4 mb-4">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-semibold">Owner & Mailing Information</div>
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <tbody data-role="owner-body">
              {% for section in sections %}
                {% if section.title == "Owner & Mailing" %}
                  {% for label, value in section.items %}
                    <tr>
                      <th class="text-muted" style="width: 45%;">{{ label }}</th>
                      <td class="fw-semibold">{{ value|default:"‚Äî" }}</td>
                    </tr>
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-semibold">Skip Trace</div>
        <div class="card-body" id="parcel-skiptrace-card">
          {% if skiptrace_allowed %}
            {# Parcel is in a saved list - show skip trace button #}
            <div class="d-flex align-items-center gap-2 mb-3">
              <button type="button"
                      class="btn btn-outline-primary btn-sm"
                      data-role="skiptrace-run"
                      {% if not skiptrace_endpoint %}disabled{% endif %}>
                {{ skiptrace_button_label }}
              </button>
              <div class="spinner-border spinner-border-sm text-primary d-none"
                   data-role="skiptrace-spinner"></div>
            </div>

            <div class="small text-muted mb-3" data-role="skiptrace-status">
              {{ skiptrace_status_message }}
            </div>

            {% if stripe_payment_required and skiptrace_pricing %}
              <div class="alert alert-info small py-2 px-3 mb-3">
                <strong>Cost:</strong> {{ skiptrace_cost_per_lookup_display }} per lookup
              </div>
            {% endif %}

            <div data-role="skiptrace-results" class="{% if not skiptrace_initial %}d-none{% endif %}">
              <table class="table table-sm mb-0">
                <tbody data-role="skiptrace-results-body">
                  {# Results populated by JavaScript #}
                </tbody>
              </table>
            </div>
          {% else %}
            {# Parcel is NOT in a saved list - show info message #}
            <div class="alert alert-warning d-flex align-items-center gap-2 mb-3">
              <i class="bi bi-info-circle"></i>
              <span class="small">
                Add this parcel to a saved list to enable skip trace capabilities.
              </span>
            </div>
            <a class="btn btn-outline-primary btn-sm" href="{% url 'saved_parcel_lists' %}">
              View Saved Lists
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {# VALUATION & SALE HISTORY - Side by Side #}
  <div class="row g-4 mb-4">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-semibold">Valuation</div>
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <tbody data-role="valuation-body">
              {% for section in sections %}
                {% if section.title == "Valuation" %}
                  {% for label, value in section.items %}
                    <tr{% if label == "Est. Mortgage Balance" %} class="border-top border-2"{% endif %}>
                      <th class="text-muted" style="width: 45%;">{{ label }}</th>
                      <td class="fw-semibold">{{ value|default:"‚Äî" }}</td>
                    </tr>
                  {% endfor %}
                {% endif %}
              {% endfor %}
              {% if market_value_comps %}
                <tr class="border-top">
                  <td colspan="2" class="py-2">
                    <div class="text-uppercase fw-semibold small text-muted">Recent Comps</div>
                  </td>
                </tr>
                {% for comp in market_value_comps %}
                  <tr>
                    <th class="text-muted" style="width: 45%;">
                      {% if comp.address %}
                        {{ comp.address }}
                      {% elif comp.url %}
                        <a href="{{ comp.url }}" class="text-decoration-none text-dark">
                          {% if comp.loc_id %}Parcel {{ comp.loc_id }}{% else %}Comparable Sale{% endif %}
                        </a>
                      {% else %}
                        {% if comp.loc_id %}Parcel {{ comp.loc_id }}{% else %}Comparable Sale{% endif %}
                      {% endif %}
                    </th>
                    <td class="fw-semibold">
                      <div>${{ comp.sale_price|floatformat:0 }}</div>
                      <div class="small fw-normal text-muted">
                        {% if comp.sale_date %}{{ comp.sale_date }}{% endif %}
                        {% if comp.style %} ¬∑ {{ comp.style }}{% endif %}
                        {% if comp.psf %} ¬∑ ${{ comp.psf|floatformat:0 }}/sf{% endif %}
                      </div>
                      <div class="small fw-normal text-muted">
                        {% if comp.living_area %}{{ comp.living_area|floatformat:0 }} sqft{% endif %}
                        {% if comp.lot_size %}
                          {% if comp.living_area %} ¬∑ {% endif %}
                          {{ comp.lot_size|floatformat:0 }} sqft lot
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-semibold">Sale History</div>
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <tbody data-role="sale-history-body">
              {% for section in sections %}
                {% if section.title == "Sale History" %}
                  {% for label, value in section.items %}
                    <tr>
                      <th class="text-muted" style="width: 45%;">{{ label }}</th>
                      <td class="fw-semibold">{{ value|default:"‚Äî" }}</td>
                    </tr>
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  {# FORECLOSURE STATUS & DEFAULT RISK - Side by Side #}
  {% if attom_data %}
  <div class="row g-4 mb-4">
    {% if attom_data.pre_foreclosure or attom_data.foreclosure_stage %}
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
          <span>Foreclosure Status</span>
          {% if attom_data.pre_foreclosure %}
            <span class="badge text-bg-danger">In Foreclosure</span>
          {% else %}
            <span class="badge text-bg-success">No Foreclosure</span>
          {% endif %}
        </div>
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <tbody>
              {% if attom_data.foreclosure_stage %}
                <tr>
                  <th class="text-muted" style="width: 45%;">Stage</th>
                  <td class="fw-semibold">{{ attom_data.foreclosure_stage }}</td>
                </tr>
              {% endif %}
              {% if attom_data.foreclosure_recording_date %}
                <tr>
                  <th class="text-muted">Recording Date</th>
                  <td class="fw-semibold">{{ attom_data.foreclosure_recording_date }}</td>
                </tr>
              {% endif %}
              {% if attom_data.foreclosure_auction_date %}
                <tr>
                  <th class="text-muted">Auction Date</th>
                  <td class="fw-semibold">{{ attom_data.foreclosure_auction_date }}</td>
                </tr>
              {% endif %}
              {% if attom_data.foreclosure_estimated_value %}
                <tr>
                  <th class="text-muted">Estimated Value</th>
                  <td class="fw-semibold">${{ attom_data.foreclosure_estimated_value|floatformat:0 }}</td>
                </tr>
              {% endif %}
              {% if attom_data.foreclosure_default_amount %}
                <tr>
                  <th class="text-muted">Default Amount</th>
                  <td class="fw-semibold">${{ attom_data.foreclosure_default_amount|floatformat:0 }}</td>
                </tr>
              {% endif %}
              {% if attom_data.foreclosure_judgment_amount %}
                <tr>
                  <th class="text-muted">Judgment Amount</th>
                  <td class="fw-semibold">${{ attom_data.foreclosure_judgment_amount|floatformat:0 }}</td>
                </tr>
              {% endif %}
              {% if attom_data.foreclosure_document_type %}
                <tr>
                  <th class="text-muted">Document Type</th>
                  <td class="fw-semibold">{{ attom_data.foreclosure_document_type }}</td>
                </tr>
              {% endif %}
              {% if not attom_data.foreclosure_stage and not attom_data.foreclosure_recording_date and not attom_data.foreclosure_auction_date and not attom_data.foreclosure_estimated_value and not attom_data.foreclosure_default_amount and not attom_data.foreclosure_judgment_amount %}
                <tr>
                  <td colspan="2" class="text-center text-muted py-3">No foreclosure activity detected</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {% if attom_data.default_risk_score is not None %}
    <div class="col-12 {% if attom_data.pre_foreclosure or attom_data.foreclosure_stage %}col-lg-6{% endif %}">
      <div class="card h-100">
        <div class="card-header fw-semibold">Default Risk Score</div>
        <div class="card-body">
          <div class="text-center mb-3">
            <div class="display-3 fw-bold {% if attom_data.default_risk_score >= 70 %}text-danger{% elif attom_data.default_risk_score >= 40 %}text-warning{% else %}text-success{% endif %}">
              {{ attom_data.default_risk_score }}
            </div>
            <div class="text-muted small">Score 0-100</div>
          </div>
          <div class="progress" style="height: 25px;">
            <div class="progress-bar {% if attom_data.default_risk_score >= 70 %}bg-danger{% elif attom_data.default_risk_score >= 40 %}bg-warning{% else %}bg-success{% endif %}"
                 role="progressbar"
                 style="width: {{ attom_data.default_risk_score }}%"
                 aria-valuenow="{{ attom_data.default_risk_score }}"
                 aria-valuemin="0"
                 aria-valuemax="100">
              {{ attom_data.default_risk_score }}%
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  {# LIENS & LEGAL ACTIONS - Simplified #}
  {% if liens or legal_actions or lien_search_requested %}
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
      <span><i class="bi bi-search me-2"></i>Liens & Legal Actions</span>
      <form method="post" action="{{ lien_refresh_endpoint }}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-outline-primary">
          {% if lien_search_requested and lien_search_queued %}
            <span class="spinner-border spinner-border-sm me-1" role="status"></span>Refreshing...
          {% else %}
            Refresh Liens & Cases
          {% endif %}
        </button>
      </form>
    </div>
    <div class="card-body">
      {# Recorded Liens #}
      <div class="mb-4">
        <h6 class="fw-semibold mb-3">
          <i class="bi bi-file-earmark-text me-2"></i>Recorded Liens
          {% if liens %}<span class="badge bg-warning text-dark ms-2">{{ liens|length }}</span>{% endif %}
        </h6>
        {% if liens %}
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Type</th>
                <th>Holder</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for lien in liens %}
              <tr>
                <td>{{ lien.type|default:"Unknown" }}</td>
                <td>{{ lien.holder|default:"N/A" }}</td>
                <td>{% if lien.amount %}${{ lien.amount|floatformat:0 }}{% else %}N/A{% endif %}</td>
                <td><span class="badge {% if lien.status == 'Active' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ lien.status|default:"Unknown" }}</span></td>
                <td>{{ lien.recording_date|default:"N/A" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted mb-0"><i class="bi bi-check-circle me-2"></i>No liens found</p>
        {% endif %}
      </div>

      {# Legal Actions #}
      <div>
        <h6 class="fw-semibold mb-3">
          <i class="bi bi-gavel me-2"></i>Legal Actions
          {% if legal_actions %}<span class="badge bg-info ms-2">{{ legal_actions|length }}</span>{% endif %}
        </h6>
        {% if legal_actions %}
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Type</th>
                <th>Case Number</th>
                <th>Status</th>
                <th>Filed</th>
                <th>Plaintiff</th>
                <th>Defendant</th>
                <th>Summary</th>
              </tr>
            </thead>
            <tbody>
              {% for action in legal_actions %}
              <tr>
                <td>
                  <span class="badge {% if action.action_type == 'foreclosure' %}bg-danger{% elif action.action_type == 'eviction' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                    {{ action.action_type|title }}
                  </span>
                </td>
                <td><code class="small">{{ action.case_number }}</code></td>
                <td><span class="badge bg-info">{{ action.status|default:"Unknown" }}</span></td>
                <td>{{ action.filing_date|default:"N/A" }}</td>
                <td class="small">{{ action.plaintiff|default:"N/A" }}</td>
                <td class="small">{{ action.defendant|default:"N/A" }}</td>
                <td class="small">
                  {% if action.description %}
                    <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ action.description }}">
                      {{ action.description|truncatewords:8 }}
                    </span>
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted mb-0"><i class="bi bi-check-circle me-2"></i>No legal actions found</p>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  {# REMAINING SECTIONS - All other property details #}
  <div class="row g-4 mb-4">
    {% for section in sections %}
      {% if section.title != "Skip Trace" and section.title != "Sale History" and section.title != "Valuation" and section.title != "Owner & Mailing" and section.title != "Property Overview" and section.title != "Location" %}
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header fw-semibold">{{ section.title }}</div>
          <div class="card-body p-0">
            <table class="table table-sm mb-0">
              <tbody>
                {% for label, value in section.items %}
                  <tr>
                    <th class="text-muted" style="width: 45%;">{{ label }}</th>
                    <td class="fw-semibold">{{ value|default:"‚Äî" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>

  {# PARCEL FOOTPRINT - Keep visible #}
  {% if parcel_shape and parcel_shape.found and parcel_shape.svg_markup %}
    <div class="row g-4 mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
            <span>Parcel Footprint</span>
            {% if parcel_shape.source_hint %}<span class="badge text-bg-light">{{ parcel_shape.source_hint }}</span>{% endif %}
          </div>
          <div class="card-body">
            <div class="ratio ratio-1x1 border rounded shadow-sm bg-white d-flex align-items-center justify-content-center mb-3" style="max-width: 500px; margin: 0 auto;">
              {{ parcel_shape.svg_markup|safe }}
            </div>
            <div class="row g-2">
              {% if parcel_shape.area %}
                <div class="col-6 col-md-3">
                  <div class="small text-muted">Area</div>
                  <div class="fw-semibold">{{ parcel_shape.area|floatformat:0 }}</div>
                </div>
              {% endif %}
              {% if parcel_shape.width %}
                <div class="col-6 col-md-3">
                  <div class="small text-muted">Width</div>
                  <div class="fw-semibold">{{ parcel_shape.width|floatformat:1 }}</div>
                </div>
              {% endif %}
              {% if parcel_shape.height %}
                <div class="col-6 col-md-3">
                  <div class="small text-muted">Height</div>
                  <div class="fw-semibold">{{ parcel_shape.height|floatformat:1 }}</div>
                </div>
              {% endif %}
              {% if parcel_shape.centroid %}
                <div class="col-12 col-md-3">
                  <div class="small text-muted">Centroid</div>
                  <div class="fw-semibold">({{ parcel_shape.centroid.0|floatformat:3 }}, {{ parcel_shape.centroid.1|floatformat:3 }})</div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {# MASSGIS ATTRIBUTES #}
  <div class="card shadow-sm">
    <div class="card-header fw-semibold d-flex justify-content-between align-items-center"
         style="cursor: pointer;"
         data-bs-toggle="collapse"
         data-bs-target="#massGisAttributesCollapse"
         aria-expanded="false"
         aria-controls="massGisAttributesCollapse">
      <span>MassGIS Attributes</span>
      <i class="bi bi-chevron-down"></i>
    </div>
    <div class="collapse" id="massGisAttributesCollapse">
      <div class="table-responsive">
        <table class="table table-striped table-sm mb-0">
          <tbody>
            {% for key, value in parcel.attributes.items %}
              <tr>
                <th class="text-uppercase small text-muted">{{ key }}</th>
                <td>{{ value|default:"‚Äî" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const mapEl = document.getElementById('parcel-map-embed');
      if (mapEl) {
        const lat = parseFloat(mapEl.dataset.lat);
        const lng = parseFloat(mapEl.dataset.lng);
        if (isNaN(lat) || isNaN(lng)) {
          mapEl.innerHTML = '<div class="d-flex align-items-center justify-content-center text-muted small">Map unavailable for this location.</div>';
        } else {
          const map = L.map(mapEl).setView([lat, lng], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          L.marker([lat, lng]).addTo(map);
        }
      }

      const skiptraceCard = document.getElementById('parcel-skiptrace-card');
      if (skiptraceCard && window.LeadCRM && window.LeadCRM.skiptrace) {
        try {
          const config = JSON.parse('{{ skiptrace_config_json|escapejs }}');
          window.LeadCRM.skiptrace.init(skiptraceCard, config);
        } catch (error) {
          console.error('Skip trace initialization error:', error);
        }
      }

      const unitsDataEl = document.getElementById('parcel-units-data');
      const unitRows = Array.from(document.querySelectorAll('[data-role="unit-row"]'));
      const valuationBody = document.querySelector('[data-role="valuation-body"]');
      const saleHistoryBody = document.querySelector('[data-role="sale-history-body"]');
      const ownerBody = document.querySelector('[data-role="owner-body"]');

      function readTableBody(bodyEl) {
        if (!bodyEl) {
          return [];
        }
        return Array.from(bodyEl.querySelectorAll('tr'))
          .map((row) => {
            const separatorCell = row.querySelector('td[colspan]');
            if (separatorCell) {
              return {
                label: separatorCell.textContent.trim(),
                value: '',
                divider: false,
                separator: true,
              };
            }
            const headerCell = row.querySelector('th');
            const valueCell = row.querySelector('td');
            if (!headerCell || !valueCell) {
              return null;
            }
            const rawLabel = headerCell.textContent.trim();
            const rawValue = valueCell.textContent.trim();
            const separatorMatch = /^‚îÄ+$/.test(rawLabel);
            return {
              label: rawLabel,
              value: rawValue,
              divider: row.classList.contains('border-top'),
              separator: separatorMatch,
            };
          })
          .filter(Boolean);
      }

      function isDisplayable(value) {
        if (value === null || value === undefined) {
          return false;
        }
        if (typeof value === 'number') {
          return value !== 0;
        }
        if (typeof value === 'string') {
          const trimmed = value.trim();
          if (!trimmed) return false;
          return !['‚Äî', '0', 'nan', 'None'].includes(trimmed);
        }
        return true;
      }

      function dedupeItems(items) {
        const seen = new Set();
        return items.filter((item) => {
          const key = item.separator ? `sep:${item.label}` : `label:${item.label}`;
          if (seen.has(key)) {
            return false;
          }
          seen.add(key);
          return true;
        });
      }

      function renderTable(bodyEl, items) {
        if (!bodyEl) {
          return;
        }
        bodyEl.innerHTML = '';
        if (!items.length) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 2;
          cell.className = 'text-muted small';
          cell.textContent = 'No details available for this unit.';
          row.appendChild(cell);
          bodyEl.appendChild(row);
          return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((item) => {
          const row = document.createElement('tr');

          if (item.separator) {
            const cell = document.createElement('td');
            cell.colSpan = 2;
            cell.className = 'text-muted';
            cell.textContent = item.label || '‚îÄ';
            row.appendChild(cell);
            fragment.appendChild(row);
            return;
          }

          if (item.divider) {
            row.classList.add('border-top', 'border-2');
          }

          const headerCell = document.createElement('th');
          headerCell.className = 'text-muted';
          headerCell.style.width = '45%';
          headerCell.textContent = item.label;

          const valueCell = document.createElement('td');
          valueCell.className = 'fw-semibold';
          valueCell.textContent = isDisplayable(item.value) ? item.value : '‚Äî';

          row.appendChild(headerCell);
          row.appendChild(valueCell);
          fragment.appendChild(row);
        });

        bodyEl.appendChild(fragment);
      }

      const attomEndpointTemplate = '{{ unit_attom_endpoint_template|escapejs }}';
      const parcelMetaEl = document.getElementById('parcel-metadata');
      const parcelLocId = parcelMetaEl ? (parcelMetaEl.dataset.parcelLoc || '') : '';
      const attomCache = new Map();
      const attomFetchInFlight = new Map();
      let activeUnitKey = null;

      if (unitsDataEl && unitRows.length && (valuationBody || saleHistoryBody)) {
        let unitsData = [];
        try {
          unitsData = JSON.parse(unitsDataEl.textContent) || [];
        } catch (error) {
          console.error('Unable to parse unit data payload:', error);
        }

        const unitsMap = new Map();
        unitsData.forEach((unit, index) => {
          const key = String(unit.row_key ?? unit.id ?? index);
          unitsMap.set(key, unit);
        });

        const baseValuationItems = readTableBody(valuationBody);
        const baseSaleItems = readTableBody(saleHistoryBody);
        const baseOwnerItems = readTableBody(ownerBody);
        const baseAbsenteeRow = baseOwnerItems.find((item) => item.label === 'Absentee Owner') || null;
        const ATTOM_VALUATION_LABELS = new Set([
          'Mortgage Balance (ATTOM)',
          'Equity (ATTOM)',
          'Equity % (ATTOM)',
          'ROI % (ATTOM)',
          'Monthly Payment (ATTOM)',
        ]);
        const ATTOM_SALE_LABELS = new Set([
          'Mortgage Amount',
          'Mortgage Date',
          'Lender',
          'Loan Type',
          'Interest Rate',
          'Loan Term',
          'Monthly Payment',
          'Tax Year',
          'Tax Assessed Value',
          'Annual Tax',
        ]);
        const baseValuationNonAttom = baseValuationItems.filter((item) => !ATTOM_VALUATION_LABELS.has(item.label));
        const baseValuationAttom = baseValuationItems.filter((item) => ATTOM_VALUATION_LABELS.has(item.label));
        const baseSaleNonAttom = baseSaleItems.filter((item) => !ATTOM_SALE_LABELS.has(item.label) && !item.separator);
        const baseSaleAttom = baseSaleItems.filter((item) => ATTOM_SALE_LABELS.has(item.label) || item.separator);

        const defaultUnitKey = '{{ unit_default_key|escapejs }}';
        if (defaultUnitKey && (baseValuationAttom.length || baseSaleAttom.length)) {
          attomCache.set(defaultUnitKey, {
            valuation: baseValuationAttom.map((item) => ({ ...item })),
            sale: baseSaleAttom.map((item) => ({ ...item })),
          });
        }

        function buildOwnerItems(unit) {
          if (!ownerBody) {
            return [];
          }
          if (!unit || !Array.isArray(unit.owner_items)) {
            return baseOwnerItems.slice();
          }
          const items = unit.owner_items
            .filter((tuple) => Array.isArray(tuple) && tuple.length >= 2)
            .map(([label, value]) => {
              const display = isDisplayable(value) ? value : '‚Äî';
              return {
                label,
                value: display,
                divider: false,
                separator: false,
              };
            });

          if (!items.length) {
            return baseOwnerItems.slice();
          }

          if (baseAbsenteeRow && !items.some((item) => item.label === 'Absentee Owner')) {
            items.push({ ...baseAbsenteeRow });
          }
          if (unit.is_master_record && !items.some((item) => item.label === 'Record Type')) {
            items.push({
              label: 'Record Type',
              value: 'Master',
              divider: false,
              separator: false,
            });
          }

          return dedupeItems(items);
        }

        function buildValuationItems(unit, key) {
          const baseItems = Array.isArray(unit?.valuation_items)
            ? unit.valuation_items
                .filter((tuple) => Array.isArray(tuple) && tuple.length >= 2 && isDisplayable(tuple[1]))
                .map(([label, value]) => ({
                  label,
                  value,
                  divider: ['Est. Mortgage Balance'].includes(label),
                  separator: /^‚îÄ+$/.test(label),
                }))
            : [];

          let merged = dedupeItems(baseItems.concat(baseValuationNonAttom));

          const attom = attomCache.get(key);
          if (attom && Array.isArray(attom.valuation) && attom.valuation.length) {
            merged = dedupeItems(merged.concat(attom.valuation));
          }

          if (!merged.length) {
            merged = baseValuationNonAttom.slice();
          }

          const totalIndex = merged.findIndex((item) => item.label === 'Total Value');
          if (totalIndex > 0) {
            const [totalRow] = merged.splice(totalIndex, 1);
            merged.unshift(totalRow);
          } else if (totalIndex === -1) {
            const fallbackTotal = baseValuationItems.find((item) => item.label === 'Total Value');
            if (fallbackTotal) {
              merged.unshift({ ...fallbackTotal });
            }
          }

          return merged.length ? merged : baseValuationItems.slice();
        }

        function buildSaleHistoryItems(unit, key) {
          const baseItems = Array.isArray(unit?.sale_history_items)
            ? unit.sale_history_items
                .filter((tuple) => Array.isArray(tuple) && tuple.length >= 2)
                .map(([label, value]) => ({
                  label,
                  value,
                  divider: false,
                  separator: /^‚îÄ+$/.test(label),
                }))
            : [];

          let merged = dedupeItems(baseItems.concat(baseSaleNonAttom));

          const attom = attomCache.get(key);
          if (attom && Array.isArray(attom.sale) && attom.sale.length) {
            merged = dedupeItems(merged.concat(attom.sale));
          }

          if (!merged.length) {
            merged = baseSaleNonAttom.slice();
          }

          return merged.length ? merged : baseSaleItems.slice();
        }

        function activateRow(targetRow) {
          unitRows.forEach((row) => {
            if (row === targetRow) {
              row.classList.add('table-active');
            } else {
              row.classList.remove('table-active');
            }
          });
        }

        function ensureAttomData(key, unit) {
          if (!attomEndpointTemplate || !unit) {
            return;
          }
          if (attomCache.has(key) || attomFetchInFlight.has(key)) {
            return;
          }

          const locId = unit.loc_id || parcelLocId;
          if (!locId) {
            return;
          }

          const url = attomEndpointTemplate.replace('__loc__', encodeURIComponent(locId));
          const params = new URLSearchParams();
          if (unit.total_value) {
            params.append('current_value', unit.total_value);
          }
          params.append('unit_key', key);
          if (unit.owner) {
            params.append('owner_name', unit.owner);
          }

          attomFetchInFlight.set(key, true);

          fetch(params.toString() ? `${url}?${params.toString()}` : url, {
            headers: { Accept: 'application/json' },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`ATTOM request failed (${response.status})`);
              }
              return response.json();
            })
            .then((data) => {
              if (data && data.hasData) {
                const valuation = Array.isArray(data.valuation)
                  ? data.valuation.map((item) => ({
                      label: item.label,
                      value: item.value,
                      divider: Boolean(item.divider),
                      separator: Boolean(item.separator),
                    }))
                  : [];
                const sale = Array.isArray(data.saleHistory)
                  ? data.saleHistory.map((item) => ({
                      label: item.label,
                      value: item.value,
                      divider: Boolean(item.divider),
                      separator: Boolean(item.separator),
                    }))
                  : [];
                attomCache.set(key, { valuation, sale });
              } else {
                attomCache.set(key, { valuation: [], sale: [] });
              }

              const currentUnit = unitsMap.get(key);
              if (currentUnit && activeUnitKey === key) {
                renderTable(valuationBody, buildValuationItems(currentUnit, key));
                renderTable(saleHistoryBody, buildSaleHistoryItems(currentUnit, key));
              }
            })
            .catch((error) => {
              console.error('ATTOM fetch failed:', error);
            })
            .finally(() => {
              attomFetchInFlight.delete(key);
            });
        }

        function selectUnit(key) {
          const normalizedKey = String(key);
          const unit = unitsMap.get(normalizedKey);
          activeUnitKey = normalizedKey;

          const valuationItems = buildValuationItems(unit, normalizedKey);
          const saleItems = buildSaleHistoryItems(unit, normalizedKey);
          const ownerItems = buildOwnerItems(unit);

          renderTable(valuationBody, valuationItems);
          renderTable(saleHistoryBody, saleItems);
          renderTable(ownerBody, ownerItems);

          const matchingRow = unitRows.find((row) => row.dataset.unitKey === normalizedKey);
          if (matchingRow) {
            activateRow(matchingRow);
          }

          ensureAttomData(normalizedKey, unit);
        }

        let isSelecting = false;

        unitRows.forEach((row) => {
          const activate = () => {
            if (isSelecting) {
              return;
            }
            isSelecting = true;
            try {
              const key = row.dataset.unitKey;
              selectUnit(key);
            } finally {
              isSelecting = false;
            }
          };

          row.addEventListener('click', activate);
          row.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              activate();
            }
          });
        });

        let initialKey = defaultUnitKey && unitsMap.has(defaultUnitKey) ? defaultUnitKey : null;
        if (!initialKey && unitRows.length) {
          initialKey = unitRows[0].dataset.unitKey;
        }
        if (initialKey) {
          selectUnit(initialKey);
        }
      }

      // Rotate chevron icon when MassGIS attributes collapse is toggled
      const massGisCollapse = document.getElementById('massGisAttributesCollapse');
      if (massGisCollapse) {
        const collapseHeader = massGisCollapse.previousElementSibling;
        const chevron = collapseHeader.querySelector('.bi-chevron-down');

        massGisCollapse.addEventListener('show.bs.collapse', function () {
          if (chevron) chevron.style.transform = 'rotate(180deg)';
        });

        massGisCollapse.addEventListener('hide.bs.collapse', function () {
          if (chevron) chevron.style.transform = 'rotate(0deg)';
        });
      }

      // Initialize Bootstrap tooltips for legal action summaries
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    });
  </script>

  <!-- Save Property Modal -->
  <div class="modal fade" id="savePropertyModal" tabindex="-1" aria-labelledby="savePropertyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="savePropertyModalLabel">
            <i class="bi bi-bookmark-plus me-2"></i>Save Property to List
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Tab Navigation -->
          <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="existing-list-tab" data-bs-toggle="tab" data-bs-target="#existing-list-pane" type="button" role="tab">
                Add to Existing List
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="new-list-tab" data-bs-toggle="tab" data-bs-target="#new-list-pane" type="button" role="tab">
                Create New List
              </button>
            </li>
          </ul>

          <!-- Tab Content -->
          <div class="tab-content">
            <!-- Existing List Tab -->
            <div class="tab-pane fade show active" id="existing-list-pane" role="tabpanel">
              <div id="existingListsLoading" class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <div class="text-muted small mt-2">Loading your lists...</div>
              </div>
              <div id="existingListsContent" style="display: none;">
                <div class="form-group">
                  <label for="existingListSelect" class="form-label">Select a list:</label>
                  <select id="existingListSelect" class="form-select">
                    <option value="">-- Choose a list --</option>
                  </select>
                  <div class="form-text">Property will be added to the selected list</div>
                </div>
              </div>
              <div id="existingListsEmpty" style="display: none;" class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>You don't have any saved lists yet. Create a new list using the tab above.
              </div>
            </div>

            <!-- New List Tab -->
            <div class="tab-pane fade" id="new-list-pane" role="tabpanel">
              <div class="form-group">
                <label for="newListName" class="form-label">List Name:</label>
                <input type="text" id="newListName" class="form-control" placeholder="e.g., High Equity Prospects">
                <div class="form-text">Enter a name for your new list</div>
              </div>
            </div>
          </div>

          <!-- Error/Success Messages -->
          <div id="savePropertyAlert" class="alert d-none mt-3" role="alert"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="savePropertyBtn">
            <i class="bi bi-bookmark-plus me-1"></i>Save Property
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const townId = {{ parcel.town.town_id }};
      const locId = "{{ parcel.loc_id }}";
      const modal = document.getElementById('savePropertyModal');
      const existingListSelect = document.getElementById('existingListSelect');
      const newListNameInput = document.getElementById('newListName');
      const saveBtn = document.getElementById('savePropertyBtn');
      const alertDiv = document.getElementById('savePropertyAlert');

      // Load existing lists when modal is shown
      modal.addEventListener('show.bs.modal', function() {
        loadExistingLists();
      });

      // Clear form when modal is hidden
      modal.addEventListener('hidden.bs.modal', function() {
        existingListSelect.value = '';
        newListNameInput.value = '';
        alertDiv.classList.add('d-none');
      });

      async function loadExistingLists() {
        const loadingEl = document.getElementById('existingListsLoading');
        const contentEl = document.getElementById('existingListsContent');
        const emptyEl = document.getElementById('existingListsEmpty');

        loadingEl.style.display = 'block';
        contentEl.style.display = 'none';
        emptyEl.style.display = 'none';

        try {
          const response = await fetch(`/api/parcel/${townId}/lists/`, {
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          if (!response.ok) throw new Error('Failed to load lists');

          const data = await response.json();

          if (data.success && data.lists.length > 0) {
            // Populate dropdown
            existingListSelect.innerHTML = '<option value="">-- Choose a list --</option>';
            data.lists.forEach(list => {
              const option = document.createElement('option');
              option.value = list.id;
              option.textContent = `${list.name} (${list.parcel_count} parcels) - ${list.town_name}`;
              existingListSelect.appendChild(option);
            });

            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';
          } else {
            loadingEl.style.display = 'none';
            emptyEl.style.display = 'block';
          }
        } catch (error) {
          console.error('Error loading lists:', error);
          showAlert('Failed to load lists. Please try again.', 'danger');
          loadingEl.style.display = 'none';
        }
      }

      saveBtn.addEventListener('click', async function() {
        const activeTab = document.querySelector('.nav-link.active').id;
        const isNewList = activeTab === 'new-list-tab';

        let formData = new FormData();

        if (isNewList) {
          const listName = newListNameInput.value.trim();
          if (!listName) {
            showAlert('Please enter a list name.', 'warning');
            return;
          }
          formData.append('list_name', listName);
        } else {
          const listId = existingListSelect.value;
          if (!listId) {
            showAlert('Please select a list.', 'warning');
            return;
          }
          formData.append('list_id', listId);
        }

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

        try {
          const response = await fetch(`/api/parcel/${townId}/${locId}/add-to-list/`, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrfToken
            },
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => {
              bootstrap.Modal.getInstance(modal).hide();
            }, 1500);
          } else {
            showAlert(data.error || 'Failed to save property.', 'danger');
          }
        } catch (error) {
          console.error('Error saving property:', error);
          showAlert('An error occurred. Please try again.', 'danger');
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="bi bi-bookmark-plus me-1"></i>Save Property';
        }
      });

      function showAlert(message, type) {
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        alertDiv.classList.remove('d-none');
      }
    })();
  </script>

  {# Keyboard navigation for list browsing #}
  {% if from_list %}
  <script>
    (function() {
      'use strict';

      // Get navigation URLs
      const prevUrl = {% if prev_parcel %}'{{ prev_parcel.url }}'{% else %}null{% endif %};
      const nextUrl = {% if next_parcel %}'{{ next_parcel.url }}'{% else %}null{% endif %};

      // Handle keyboard navigation
      document.addEventListener('keydown', function(e) {
        // Ignore if user is typing in an input, textarea, or select element
        const target = e.target;
        if (target.tagName === 'INPUT' ||
            target.tagName === 'TEXTAREA' ||
            target.tagName === 'SELECT' ||
            target.isContentEditable) {
          return;
        }

        // Left arrow key - go to previous parcel
        if (e.key === 'ArrowLeft' && prevUrl) {
          e.preventDefault();
          window.location.href = prevUrl;
        }

        // Right arrow key - go to next parcel
        if (e.key === 'ArrowRight' && nextUrl) {
          e.preventDefault();
          window.location.href = nextUrl;
        }
      });

      // Add visual feedback on button hover
      const prevBtn = document.getElementById('prevParcelBtn');
      const nextBtn = document.getElementById('nextParcelBtn');

      if (prevBtn) {
        prevBtn.addEventListener('mouseenter', function() {
          this.innerHTML = '‚Üê Previous <small class="text-muted">(‚Üê)</small>';
        });
        prevBtn.addEventListener('mouseleave', function() {
          this.innerHTML = '‚Üê Previous';
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener('mouseenter', function() {
          this.innerHTML = 'Next ‚Üí <small class="text-muted">(‚Üí)</small>';
        });
        nextBtn.addEventListener('mouseleave', function() {
          this.innerHTML = 'Next ‚Üí';
        });
      }
    })();
  </script>
  {% endif %}
{% endblock %}
