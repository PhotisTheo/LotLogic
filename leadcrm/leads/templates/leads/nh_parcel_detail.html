{% extends "base.html" %}
{% load static %}

{% block title %}{{ loc_id }} - {{ town_name }}, NH{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">{{ parcel_props.StreetAddress|default:"Address Not Available" }}</h2>
                    <p class="text-muted mb-0">{{ town_name }}, New Hampshire</p>
                </div>
                <div>
                    <a href="{% url 'parcel_search' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Search
                    </a>
                </div>
            </div>

            <!-- Limited Data Notice -->
            <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                <i class="bi bi-info-circle-fill me-2"></i>
                <div>
                    <strong>Limited Data - NH Parcel</strong><br>
                    New Hampshire parcels from NH GRANIT provide geometry and land use data only.
                    Owner names, assessed values, and building details are not available from this source.
                </div>
            </div>

            <!-- Parcel Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-house-door"></i> Parcel Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Parcel ID (PID):</strong><br>
                            <span class="text-muted">{{ parcel_props.PID|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>NH GIS ID:</strong><br>
                            <span class="text-muted">{{ parcel_props.NH_GIS_ID|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Street Address:</strong><br>
                            <span class="text-muted">{{ parcel_props.StreetAddress|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Town:</strong><br>
                            <span class="text-muted">{{ town_name }}, NH</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Land Use Code:</strong><br>
                            <span class="text-muted">{{ parcel_props.SLU|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Land Use Category:</strong><br>
                            <span class="text-muted">{{ parcel_props.SLUC|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Lot Size:</strong><br>
                            <span class="text-muted">
                                {% if parcel_props.Shape_Area %}
                                    {{ parcel_props.Shape_Area|floatformat:0 }} sq ft
                                    ({% widthratio parcel_props.Shape_Area 43560 1 %}.{% widthratio parcel_props.Shape_Area 4356 1|stringformat:"02d"|slice:"-2:" %} acres)
                                {% else %}
                                    Not Available
                                {% endif %}
                            </span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>County:</strong><br>
                            <span class="text-muted">{{ parcel_props.CountyId|default:"Not Available" }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Card -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-map"></i> Parcel Map</h5>
                </div>
                <div class="card-body p-0">
                    <div id="parcel-map" style="height: 500px; width: 100%;"></div>
                </div>
            </div>

            <!-- Data Source Information -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-database"></i> Data Source</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Source:</strong> NH GRANIT - New Hampshire Geographically Referenced Analysis and Information Transfer System
                    </p>
                    <p class="mb-2">
                        <strong>Data Provided:</strong> Parcel boundaries, addresses, and land use classifications
                    </p>
                    <p class="mb-0">
                        <strong>Not Included:</strong> Owner information, assessed values, building details, sale history
                    </p>
                    <p class="mt-3 mb-0 text-muted small">
                        For complete property information including owner names and assessed values,
                        please visit the {{ town_name }} town assessor's website or registry of deeds.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map
    const parcelData = {{ parcel_data|safe }};
    const geometry = parcelData.geometry;

    if (geometry && geometry.type === 'Polygon') {
        const coordinates = geometry.coordinates[0];

        // Convert GeoJSON [lng, lat] to Leaflet [lat, lng]
        const leafletCoords = coordinates.map(coord => [coord[1], coord[0]]);

        // Calculate center
        let sumLat = 0, sumLng = 0;
        leafletCoords.forEach(coord => {
            sumLat += coord[0];
            sumLng += coord[1];
        });
        const centerLat = sumLat / leafletCoords.length;
        const centerLng = sumLng / leafletCoords.length;

        // Create map
        const map = L.map('parcel-map').setView([centerLat, centerLng], 17);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Add parcel polygon
        const polygon = L.polygon(leafletCoords, {
            color: '#2563eb',
            weight: 3,
            opacity: 0.9,
            fillColor: '#60a5fa',
            fillOpacity: 0.3
        }).addTo(map);

        // Fit map to polygon bounds
        map.fitBounds(polygon.getBounds(), { padding: [50, 50] });

        // Add marker at center
        L.marker([centerLat, centerLng]).addTo(map)
            .bindPopup('<strong>{{ parcel_props.StreetAddress|default:"Parcel" }}</strong><br>{{ town_name }}, NH');
    } else {
        document.getElementById('parcel-map').innerHTML = '<div class="p-4 text-center text-muted">Map not available - no geometry data</div>';
    }
});
</script>
{% endblock %}
