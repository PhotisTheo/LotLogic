{% extends "base.html" %}
{% load static %}

{% block title %}{{ loc_id }} - {{ town_name }}, NH{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">{{ parcel_props.StreetAddress|default:"Address Not Available" }}</h2>
                    <p class="text-muted mb-0">{{ town_name }}, New Hampshire</p>
                </div>
                <div>
                    <a href="{% url 'parcel_search' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Search
                    </a>
                </div>
            </div>

            <!-- Limited Data Notice -->
            {% if not cama_data %}
            <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <div>
                    <strong>Limited Assessment Data</strong><br>
                    CAMA assessment data not available for this parcel. Showing geometry and land use only.
                </div>
            </div>
            {% endif %}

            <!-- Parcel Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-house-door"></i> Parcel Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Parcel ID (PID):</strong><br>
                            <span class="text-muted">{{ parcel_props.PID|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>NH GIS ID:</strong><br>
                            <span class="text-muted">{{ parcel_props.NH_GIS_ID|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Street Address:</strong><br>
                            <span class="text-muted">{{ parcel_props.StreetAddress|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Town:</strong><br>
                            <span class="text-muted">{{ town_name }}, NH</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Land Use Code:</strong><br>
                            <span class="text-muted">{{ parcel_props.SLU|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Land Use Category:</strong><br>
                            <span class="text-muted">{{ parcel_props.SLUC|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Lot Size:</strong><br>
                            <span class="text-muted">
                                {% if parcel_props.Shape_Area %}
                                    {{ parcel_props.Shape_Area|floatformat:0 }} sq ft
                                    ({% widthratio parcel_props.Shape_Area 43560 1 %}.{% widthratio parcel_props.Shape_Area 4356 1|stringformat:"02d"|slice:"-2:" %} acres)
                                {% else %}
                                    Not Available
                                {% endif %}
                            </span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>County:</strong><br>
                            <span class="text-muted">{{ parcel_props.CountyId|default:"Not Available" }}</span>
                        </div>
                    </div>
                </div>
            </div>

            {% if owner_details %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-person-badge"></i> Ownership & Mailing</h5>
                    {% if owner_details.is_absentee %}
                    <span class="badge bg-warning text-dark">Absentee Owner</span>
                    {% elif owner_details.is_absentee is not None %}
                    <span class="badge bg-success">Owner Occupied</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Owner Name:</strong><br>
                            <span class="text-muted">{{ owner_details.owner_name|default:"Not Available" }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Mailing Address:</strong><br>
                            <span class="text-muted">
                                {% if owner_details.mailing_street %}
                                    {{ owner_details.mailing_street }}<br>
                                {% endif %}
                                {% if owner_details.mailing_city or owner_details.mailing_state %}
                                    {{ owner_details.mailing_city|default:"" }}{% if owner_details.mailing_city and owner_details.mailing_state %}, {% endif %}{{ owner_details.mailing_state|default:"" }}
                                {% endif %}
                                {% if owner_details.mailing_zip %}
                                    {{ owner_details.mailing_zip }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Data Source:</strong><br>
                            <span class="text-muted">{{ owner_details.source|default:"Municipal GIS" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Tax Assessment Card (CAMA Data) -->
            {% if cama_data %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Tax Assessment {% if parcel_props.CamaYear %}({{ parcel_props.CamaYear }}){% endif %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Total Assessed Value:</strong><br>
                            <span class="fs-4 text-success">
                                {% if parcel_props.TaxTotal %}
                                    ${{ parcel_props.TaxTotal|floatformat:0 }}
                                {% else %}
                                    Not Available
                                {% endif %}
                            </span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Previous Year Total:</strong><br>
                            <span class="text-muted">
                                {% if parcel_props.PrevTaxTot %}
                                    ${{ parcel_props.PrevTaxTot|floatformat:0 }}
                                    {% if parcel_props.TaxTotal and parcel_props.PrevTaxTot %}
                                        {% widthratio parcel_props.TaxTotal parcel_props.PrevTaxTot 100 as pct %}
                                        {% if pct > 100 %}
                                            <span class="badge bg-danger">+{{ pct|add:"-100" }}%</span>
                                        {% elif pct < 100 %}
                                            <span class="badge bg-success">{{ pct|add:"-100" }}%</span>
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    Not Available
                                {% endif %}
                            </span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <strong>Land Value:</strong><br>
                            <span class="text-muted">
                                {% if parcel_props.TaxLand %}
                                    ${{ parcel_props.TaxLand|floatformat:0 }}
                                {% else %}
                                    Not Available
                                {% endif %}
                            </span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <strong>Building Value:</strong><br>
                            <span class="text-muted">
                                {% if parcel_props.TaxBldg %}
                                    ${{ parcel_props.TaxBldg|floatformat:0 }}
                                {% else %}
                                    Not Available
                                {% endif %}
                            </span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <strong>Assessment Year:</strong><br>
                            <span class="text-muted">{{ parcel_props.CamaYear|default:"Not Available" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Map Card -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-map"></i> Parcel Map</h5>
                </div>
                <div class="card-body p-0">
                    <div id="parcel-map" style="height: 500px; width: 100%;"></div>
                </div>
            </div>

            <!-- Data Source Information -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-database"></i> Data Source</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Source:</strong> NH GRANIT - New Hampshire Geographically Referenced Analysis and Information Transfer System
                    </p>
                    <p class="mb-2">
                        <strong>Data Provided:</strong> Parcel boundaries, addresses, and land use classifications
                    </p>
                    {% if owner_details %}
                    <p class="mb-2">
                        <strong>Owner & Mailing Data:</strong> {{ owner_details.source|default:"Municipal GIS (ArcGIS)" }}
                    </p>
                    {% endif %}
                    <p class="mb-0">
                        <strong>Not Included:</strong> Sale history, deed images, and detailed building characteristics
                    </p>
                    <p class="mt-3 mb-0 text-muted small">
                        For complete property information including owner names and assessed values,
                        please visit the {{ town_name }} town assessor's website or registry of deeds.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map
    const parcelData = {{ parcel_data|safe }};
    const geometry = parcelData.geometry;

    if (geometry && geometry.type === 'Polygon') {
        const coordinates = geometry.coordinates[0];

        // Convert GeoJSON [lng, lat] to Leaflet [lat, lng]
        const leafletCoords = coordinates.map(coord => [coord[1], coord[0]]);

        // Calculate center
        let sumLat = 0, sumLng = 0;
        leafletCoords.forEach(coord => {
            sumLat += coord[0];
            sumLng += coord[1];
        });
        const centerLat = sumLat / leafletCoords.length;
        const centerLng = sumLng / leafletCoords.length;

        // Create map
        const map = L.map('parcel-map').setView([centerLat, centerLng], 17);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Add parcel polygon
        const polygon = L.polygon(leafletCoords, {
            color: '#2563eb',
            weight: 3,
            opacity: 0.9,
            fillColor: '#60a5fa',
            fillOpacity: 0.3
        }).addTo(map);

        // Fit map to polygon bounds
        map.fitBounds(polygon.getBounds(), { padding: [50, 50] });

        // Add marker at center
        L.marker([centerLat, centerLng]).addTo(map)
            .bindPopup('<strong>{{ parcel_props.StreetAddress|default:"Parcel" }}</strong><br>{{ town_name }}, NH');
    } else {
        document.getElementById('parcel-map').innerHTML = '<div class="p-4 text-center text-muted">Map not available - no geometry data</div>';
    }
});
</script>
{% endblock %}
