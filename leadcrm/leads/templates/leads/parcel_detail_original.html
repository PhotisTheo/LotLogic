{% extends "leads/base.html" %}

{% block title %}Parcel ‚Äì {{ parcel.site_address|default:parcel.loc_id }}{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
{% endblock %}

{% block content %}
  <div class="page-header mb-4">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
      <div>
        <div class="text-uppercase text-muted small">MassGIS Parcel</div>
        <h1 class="mb-1">{{ parcel.site_address|default:parcel.loc_id }}</h1>
        <div class="text-muted">{{ parcel.site_city|default:parcel.town.name }}{% if parcel.site_zip %} ¬∑ {{ parcel.site_zip }}{% endif %}</div>
      </div>
      <div class="text-md-end">
        <div class="stat-pill mb-2">{{ parcel.property_category }}</div>
        <span class="badge {% if parcel.absentee %}text-bg-warning text-dark{% else %}text-bg-success{% endif %}">
          {% if parcel.absentee %}Absentee Owner{% else %}Owner Occupied{% endif %}
        </span>
      </div>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 mb-4">
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'parcel_search' %}">‚¨Ö Back to Search</a>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'saved_parcel_lists' %}">üìÅ Saved Lists</a>
  </div>

  {% if property_summary %}
    <div class="card shadow-sm mb-4">
      <div class="card-header fw-semibold">
        <i class="fa-solid fa-wand-magic-sparkles me-2"></i>AI Property Summary
      </div>
      <div class="card-body">
        <p class="card-text">{{ property_summary }}</p>
      </div>
    </div>
  {% endif %}

  <div class="row g-4 mb-4">
    {% for section in sections %}
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header fw-semibold">{{ section.title }}</div>
          {% if section.title == "Skip Trace" %}
            <div class="card-body" id="parcel-skiptrace-card">
              {% if skiptrace_allowed %}
                {# Parcel is in a saved list - show skip trace button #}
                <div class="d-flex align-items-center gap-2 mb-3">
                  <button type="button"
                          class="btn btn-outline-primary btn-sm"
                          data-role="skiptrace-run"
                          {% if not skiptrace_endpoint %}disabled{% endif %}>
                    {{ skiptrace_button_label }}
                  </button>
                  <div class="spinner-border spinner-border-sm text-primary d-none"
                       data-role="skiptrace-spinner"></div>
                </div>

                <div class="small text-muted mb-3" data-role="skiptrace-status">
                  {{ skiptrace_status_message }}
                </div>

                {% if stripe_payment_required and skiptrace_pricing %}
                  <div class="alert alert-info small py-2 px-3 mb-3">
                    <strong>Cost:</strong> {{ skiptrace_cost_per_lookup_display }} per lookup
                  </div>
                {% endif %}

                <div data-role="skiptrace-results" class="{% if not skiptrace_initial %}d-none{% endif %}">
                  <table class="table table-sm mb-0">
                    <tbody data-role="skiptrace-results-body">
                      {# Results populated by JavaScript #}
                    </tbody>
                  </table>
                </div>
              {% else %}
                {# Parcel is NOT in a saved list - show info message #}
                <div class="alert alert-warning d-flex align-items-center gap-2 mb-3">
                  <i class="bi bi-info-circle"></i>
                  <span class="small">
                    Add this parcel to a saved list to enable skip trace capabilities.
                  </span>
                </div>
                <a class="btn btn-outline-primary btn-sm" href="{% url 'saved_parcel_lists' %}">
                  View Saved Lists
                </a>
              {% endif %}
            </div>
          {% else %}
            <div class="card-body p-0">
              <table class="table table-sm mb-0">
                <tbody>
                  {% for label, value in section.items %}
                    <tr>
                      <th class="text-muted" style="width: 45%;">{{ label }}</th>
                      <td class="fw-semibold">{{ value }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
    {% if attom_data %}
      {# Foreclosure Section #}
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
            <span>Foreclosure Status</span>
            {% if attom_data.pre_foreclosure %}
              <span class="badge text-bg-danger">In Foreclosure</span>
            {% else %}
              <span class="badge text-bg-success">No Foreclosure</span>
            {% endif %}
          </div>
          <div class="card-body p-0">
            <table class="table table-sm mb-0">
              <tbody>
                {% if attom_data.foreclosure_stage %}
                  <tr>
                    <th class="text-muted" style="width: 45%;">Stage</th>
                    <td class="fw-semibold">{{ attom_data.foreclosure_stage }}</td>
                  </tr>
                {% endif %}
                {% if attom_data.foreclosure_recording_date %}
                  <tr>
                    <th class="text-muted" style="width: 45%;">Recording Date</th>
                    <td class="fw-semibold">{{ attom_data.foreclosure_recording_date }}</td>
                  </tr>
                {% endif %}
                {% if attom_data.foreclosure_auction_date %}
                  <tr>
                    <th class="text-muted" style="width: 45%;">Auction Date</th>
                    <td class="fw-semibold">{{ attom_data.foreclosure_auction_date }}</td>
                  </tr>
                {% endif %}
                {% if attom_data.foreclosure_estimated_value %}
                  <tr>
                    <th class="text-muted" style="width: 45%;">Estimated Value</th>
                    <td class="fw-semibold">${{ attom_data.foreclosure_estimated_value|floatformat:0 }}</td>
                  </tr>
                {% endif %}
                {% if attom_data.foreclosure_default_amount %}
                  <tr>
                    <th class="text-muted" style="width: 45%;">Default Amount</th>
                    <td class="fw-semibold">${{ attom_data.foreclosure_default_amount|floatformat:0 }}</td>
                  </tr>
                {% endif %}
                {% if attom_data.foreclosure_judgment_amount %}
                  <tr>
                    <th class="text-muted" style="width: 45%;">Judgment Amount</th>
                    <td class="fw-semibold">${{ attom_data.foreclosure_judgment_amount|floatformat:0 }}</td>
                  </tr>
                {% endif %}
                {% if attom_data.foreclosure_document_type %}
                  <tr>
                    <th class="text-muted" style="width: 45%;">Document Type</th>
                    <td class="fw-semibold">{{ attom_data.foreclosure_document_type }}</td>
                  </tr>
                {% endif %}
                {% if not attom_data.foreclosure_stage and not attom_data.foreclosure_recording_date and not attom_data.foreclosure_auction_date and not attom_data.foreclosure_estimated_value and not attom_data.foreclosure_default_amount and not attom_data.foreclosure_judgment_amount %}
                  <tr>
                    <td colspan="2" class="text-center text-muted py-3">No foreclosure activity detected</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>


      {# Propensity to Default Score Section #}
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header fw-semibold">Default Risk Score</div>
          <div class="card-body">
            {% if attom_data.propensity_to_default_score %}
              <div class="text-center mb-3">
                <div class="display-4 fw-bold mb-2
                  {% if attom_data.propensity_to_default_score >= 70 %}text-danger
                  {% elif attom_data.propensity_to_default_score >= 40 %}text-warning
                  {% else %}text-success{% endif %}">
                  {{ attom_data.propensity_to_default_score }}
                </div>
                <div class="text-muted small">out of 100</div>
              </div>
              <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar
                  {% if attom_data.propensity_to_default_score >= 70 %}bg-danger
                  {% elif attom_data.propensity_to_default_score >= 40 %}bg-warning
                  {% else %}bg-success{% endif %}"
                  role="progressbar"
                  style="width: {{ attom_data.propensity_to_default_score }}%"
                  aria-valuenow="{{ attom_data.propensity_to_default_score }}"
                  aria-valuemin="0"
                  aria-valuemax="100">
                </div>
              </div>
              {% if attom_data.propensity_to_default_decile %}
                <div class="alert alert-info py-2 px-3 small mb-0">
                  <strong>Risk Decile:</strong> {{ attom_data.propensity_to_default_decile }} of 10
                  {% if attom_data.propensity_to_default_decile >= 9 %}
                    <br><em>This property is in the top 10% highest risk for default.</em>
                  {% elif attom_data.propensity_to_default_decile >= 7 %}
                    <br><em>This property has an elevated risk of default.</em>
                  {% else %}
                    <br><em>This property has a lower risk of default.</em>
                  {% endif %}
                </div>
              {% endif %}
              <div class="text-muted small mt-3">
                <strong>Note:</strong> Higher scores indicate greater likelihood of default within 12 months.
              </div>
            {% else %}
              <div class="text-center text-muted py-3">
                No propensity to default score available
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      {# Data Update Info #}
      <div class="col-12">
        <div class="text-muted small text-center">
          <em>ATTOM data last updated: {{ attom_data.last_updated|date:"M d, Y P" }}</em>
        </div>
      </div>
    {% endif %}
  </div>

  {# Liens & Legal Actions Section #}
  <div class="row g-4 mb-4">
    <div class="col-12">
      <h5 class="mb-3 d-flex justify-content-between align-items-center">
        <span><i class="bi bi-search me-2"></i>Liens & Legal Actions</span>
        <form method="post" action="{{ lien_refresh_endpoint }}" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button type="submit" class="btn btn-sm btn-outline-primary">
            {% if lien_search_requested and lien_search_queued %}<span class="spinner-border spinner-border-sm me-1" role="status"></span>Refreshing...{% else %}Refresh Liens & Cases{% endif %}
          </button>
        </form>
      </h5>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
          <span><i class="bi bi-file-earmark-text me-2"></i>Recorded Liens</span>
          <form method="post" action="{{ lien_refresh_endpoint }}" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-sm btn-outline-primary">Refresh</button>
          </form>
        </div>
        <div class="card-body p-0">
          {% if lien_search_requested %}
            <div class="px-3 py-2 border-bottom bg-info-subtle text-info-emphasis small">
              <i class="bi bi-arrow-repeat me-1"></i>
              {% if liens %}
                Refreshing lien data in the background. Page will auto-refresh to show new results.
              {% else %}
                Running lien search for this parcel in the background. Page will auto-refresh when complete.
              {% endif %}
              {% if lien_last_search_at %}
                <div class="text-muted mt-1">Last checked {{ lien_last_search_at|date:"M d, Y h:i A" }}</div>
              {% endif %}
            </div>
          {% elif not lien_auto_search_enabled and not liens %}
            <div class="px-3 py-2 border-bottom bg-warning-subtle text-warning-emphasis small">
              <i class="bi bi-info-circle me-1"></i>
              Apply additional filters (under {{ lien_auto_search_threshold|default:1000 }} parcels) to automatically run lien searches for this parcel.
            </div>
          {% endif %}
          {% if liens %}
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Type</th>
                    <th>Holder</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Source</th>
                  </tr>
                </thead>
                <tbody>
                  {% for lien in liens %}
                    <tr>
                      <td>
                        <span class="badge text-bg-secondary small">{{ lien.get_lien_type_display }}</span>
                      </td>
                      <td>
                        <div class="fw-semibold small">{{ lien.lien_holder }}</div>
                        {% if lien.source %}
                          <div class="text-muted" style="font-size: 0.75rem;">{{ lien.source|truncatechars:30 }}</div>
                        {% endif %}
                      </td>
                      <td class="fw-semibold">${{ lien.amount|floatformat:0|default:"‚Äî" }}</td>
                      <td>
                        <span class="badge {% if lien.status == 'active' %}text-bg-warning{% elif lien.status == 'released' %}text-bg-success{% else %}text-bg-secondary{% endif %}">
                          {{ lien.get_status_display }}
                        </span>
                      </td>
                      <td class="small text-muted">{{ lien.recording_date|date:"M d, Y"|default:"‚Äî" }}</td>
                      <td class="small">
                        {% if lien.source_url %}
                          <a href="{{ lien.source_url }}" target="_blank" rel="noopener" class="text-decoration-none">
                            {{ lien.source|truncatechars:25 }} <i class="bi bi-box-arrow-up-right"></i>
                          </a>
                        {% else %}
                          {{ lien.source|default:"Auto-imported"|truncatechars:25 }}
                        {% endif %}
                      </td>
                    </tr>
                    {% if lien.notes %}
                      <tr class="border-0">
                        <td colspan="6" class="pt-0 pb-2">
                          <div class="small text-muted ps-3">
                            <i class="bi bi-chat-left-text me-1"></i>{{ lien.notes|truncatechars:100 }}
                          </div>
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-file-earmark-text" style="font-size: 2rem; opacity: 0.3;"></i>
              <p class="mb-0 small fw-semibold">No liens found</p>
              <p class="small mb-2 mt-2">To find liens, manually check:</p>
              <ul class="small text-start d-inline-block mt-2" style="max-width: 350px;">
                <li><a href="https://masslandrecords.com" target="_blank">Registry of Deeds</a> - Search by owner: {{ parcel.owner_name }}</li>
                <li>Municipal Tax Records - Check {{ parcel.town.name }} collector/treasurer</li>
                <li><a href="https://www.sec.state.ma.us/cor/corucc/uccidx.htm" target="_blank">UCC Filings</a> - MA Secretary of Commonwealth</li>
                <li>Federal Tax Liens - Check county registry</li>
              </ul>
              <p class="small text-muted mt-2 fst-italic">Note: Most lien sources require manual lookup</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
          <span><i class="bi bi-gavel me-2"></i>Legal Actions</span>
          <form method="post" action="{{ lien_refresh_endpoint }}" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-sm btn-outline-primary">Refresh</button>
          </form>
        </div>
        <div class="card-body p-0">
          {% if lien_search_requested %}
            <div class="px-3 py-2 border-bottom bg-info-subtle text-info-emphasis small">
              <i class="bi bi-arrow-repeat me-1"></i>
              {% if legal_actions %}
                Refreshing court data in the background. Page will auto-refresh to show new results.
              {% else %}
                Running court searches for this parcel in the background. Page will auto-refresh when complete.
              {% endif %}
              {% if lien_last_search_at %}
                <div class="text-muted mt-1">Last checked {{ lien_last_search_at|date:"M d, Y h:i A" }}</div>
              {% endif %}
            </div>
          {% elif not lien_auto_search_enabled and not legal_actions %}
            <div class="px-3 py-2 border-bottom bg-warning-subtle text-warning-emphasis small">
              <i class="bi bi-info-circle me-1"></i>
              Narrow your parcel results to under {{ lien_auto_search_threshold|default:1000 }} to trigger automated court record searches.
            </div>
          {% endif %}
          {% if legal_actions %}
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Type</th>
                    <th>Case</th>
                    <th>Status</th>
                    <th>Filed</th>
                    <th>Source</th>
                  </tr>
                </thead>
                <tbody>
                  {% for action in legal_actions %}
                    <tr>
                      <td>
                        <span class="badge
                          {% if action.action_type == 'foreclosure' %}text-bg-danger
                          {% elif action.action_type == 'eviction' %}text-bg-warning
                          {% elif 'bankruptcy' in action.action_type %}text-bg-dark
                          {% else %}text-bg-secondary{% endif %} small">
                          {{ action.get_action_type_display }}
                        </span>
                      </td>
                      <td>
                        <div class="fw-semibold small">{{ action.case_number }}</div>
                        <div class="text-muted" style="font-size: 0.70rem;">{{ action.get_court_display }}</div>
                        {% if action.plaintiff and action.defendant %}
                          <div class="text-muted" style="font-size: 0.70rem;">
                            {{ action.plaintiff|truncatechars:20 }} v. {{ action.defendant|truncatechars:20 }}
                          </div>
                        {% endif %}
                      </td>
                      <td>
                        <span class="badge
                          {% if action.status == 'active' or action.status == 'pending' %}text-bg-warning
                          {% elif action.status == 'judgment' %}text-bg-danger
                          {% elif action.status == 'dismissed' or action.status == 'closed' %}text-bg-success
                          {% else %}text-bg-secondary{% endif %}">
                          {{ action.get_status_display }}
                        </span>
                      </td>
                      <td class="small text-muted">{{ action.filing_date|date:"M d, Y"|default:"‚Äî" }}</td>
                      <td class="small">
                        {% if action.source_url %}
                          <a href="{{ action.source_url }}" target="_blank" rel="noopener" class="text-decoration-none">
                            {{ action.source|truncatechars:20 }} <i class="bi bi-box-arrow-up-right"></i>
                          </a>
                        {% else %}
                          {{ action.source|default:"Auto-imported"|truncatechars:20 }}
                        {% endif %}
                      </td>
                    </tr>
                    {% if action.description %}
                      <tr class="border-0">
                        <td colspan="5" class="pt-0 pb-2">
                          <div class="small text-muted ps-3">
                            <i class="bi bi-info-circle me-1"></i>{{ action.description|truncatechars:100 }}
                          </div>
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-gavel" style="font-size: 2rem; opacity: 0.3;"></i>
              <p class="mb-0 small fw-semibold">No legal actions found</p>
              <p class="small mb-2 mt-2">To find legal actions, manually check:</p>
              <ul class="small text-start d-inline-block mt-2" style="max-width: 350px;">
                <li><a href="https://www.courtlistener.com" target="_blank">CourtListener</a> - Federal & Bankruptcy cases (requires API key for auto-fetch)</li>
                <li><a href="https://www.masscourts.org/eservices/" target="_blank">MA Trial Court eAccess</a> - State court cases</li>
                <li><a href="https://pacer.uscourts.gov" target="_blank">PACER</a> - Federal cases (fee-based)</li>
                <li>Search by owner name: {{ parcel.owner_name }}</li>
              </ul>
              <p class="small text-muted mt-2 fst-italic">Note: Configure COURTLISTENER_API_KEY for automatic federal case searches</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if google_maps %}
    <div class="row g-4 mb-4">
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header fw-semibold">Google Map</div>
          <div class="card-body p-0">
            <div class="ratio ratio-4x3">
              {% if google_maps.lat and google_maps.lng %}
                <iframe
                  src="https://maps.google.com/maps?q={{ google_maps.lat }},{{ google_maps.lng }}&z=18&output=embed"
                  width="100%"
                  height="100%"
                  style="border:0;"
                  allowfullscreen
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"></iframe>
              {% elif google_maps.address %}
                <iframe
                  src="https://maps.google.com/maps?q={{ google_maps.address|urlencode }}&output=embed"
                  width="100%"
                  height="100%"
                  style="border:0;"
                  allowfullscreen
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"></iframe>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header fw-semibold">Property Preview</div>
          <div class="card-body p-0">
            {% if property_embed_url %}
              <div class="ratio ratio-4x3">
                <iframe src="{{ property_embed_url }}" width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy"></iframe>
              </div>
            {% elif google_maps and google_maps.lat and google_maps.lng %}
              <div class="ratio ratio-4x3" id="parcel-map-embed"
                   data-lat="{{ google_maps.lat }}"
                   data-lng="{{ google_maps.lng }}">
                <div class="d-flex align-items-center justify-content-center text-muted small">Loading map‚Ä¶</div>
              </div>
            {% else %}
              <div class="ratio ratio-4x3 bg-light d-flex align-items-center justify-content-center text-muted small">
                Map information not available.
              </div>
            {% endif %}
            {% if zillow_url %}
              <div class="px-3 py-3 border-top text-center">
                <a class="btn btn-sm btn-outline-primary" href="{{ zillow_url }}" target="_blank" rel="noopener">View on Zillow</a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% if parcel_shape and parcel_shape.found and parcel_shape.svg_markup %}
    <div class="row g-4 mb-4">
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
            <span>Parcel Footprint</span>
            {% if parcel_shape.source_hint %}<span class="badge text-bg-light">{{ parcel_shape.source_hint }}</span>{% endif %}
          </div>
          <div class="card-body">
            <div class="ratio ratio-1x1 border rounded shadow-sm bg-white d-flex align-items-center justify-content-center mb-3">
              {{ parcel_shape.svg_markup|safe }}
            </div>
            <div class="row g-2">
              {% if parcel_shape.area %}
                <div class="col-6">
                  <div class="small text-muted">Area</div>
                  <div class="fw-semibold">{{ parcel_shape.area|floatformat:0 }}</div>
                </div>
              {% endif %}
              {% if parcel_shape.width %}
                <div class="col-6">
                  <div class="small text-muted">Width</div>
                  <div class="fw-semibold">{{ parcel_shape.width|floatformat:1 }}</div>
                </div>
              {% endif %}
              {% if parcel_shape.height %}
                <div class="col-6">
                  <div class="small text-muted">Height</div>
                  <div class="fw-semibold">{{ parcel_shape.height|floatformat:1 }}</div>
                </div>
              {% endif %}
              {% if parcel_shape.centroid %}
                <div class="col-12">
                  <div class="small text-muted">Centroid</div>
                  <div class="fw-semibold">({{ parcel_shape.centroid.0|floatformat:3 }}, {{ parcel_shape.centroid.1|floatformat:3 }})</div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% include "leads/partials/mailer_card.html" with mailer=mailer column_class="col-12 col-lg-6" mailer_generate_endpoint=mailer_generate_endpoint mailer_download_endpoint=mailer_download_endpoint %}
    </div>
  {% elif mailer %}
    <div class="row g-4 mb-4">
      {% include "leads/partials/mailer_card.html" with mailer=mailer column_class="col-12" mailer_generate_endpoint=mailer_generate_endpoint mailer_download_endpoint=mailer_download_endpoint %}
    </div>
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-header fw-semibold">MassGIS Attributes</div>
    <div class="table-responsive">
      <table class="table table-striped table-sm mb-0">
        <tbody>
          {% for key, value in parcel.attributes.items %}
            <tr>
              <th class="text-uppercase small text-muted">{{ key }}</th>
              <td>{{ value|default:"‚Äî" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const mapEl = document.getElementById('parcel-map-embed');
      if (mapEl) {
        const lat = parseFloat(mapEl.dataset.lat);
        const lng = parseFloat(mapEl.dataset.lng);
        if (isNaN(lat) || isNaN(lng)) {
          mapEl.innerHTML = '<div class="d-flex align-items-center justify-content-center text-muted small">Map unavailable for this location.</div>';
        } else {
          const map = L.map(mapEl).setView([lat, lng], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          L.marker([lat, lng]).addTo(map);
        }
      }

      const mailerCard = document.getElementById('parcel-mailer-card');
      if (mailerCard) {
        let scriptMap = {};
        try {
          scriptMap = JSON.parse(mailerCard.dataset.scriptMap || '{}');
        } catch (error) {
          console.warn('Mailer scripts could not be parsed', error);
        }

        const select = mailerCard.querySelector('[data-role="mailer-script-select"]');
        const summaryEl = mailerCard.querySelector('[data-role="mailer-summary"]');
        const previewContainer = mailerCard.querySelector('[data-role="mailer-root"]');
        const downloadLink = mailerCard.querySelector('[data-role="mailer-download"]');
        const downloadBase = mailerCard.dataset.downloadBase || '';

        const applyScript = (scriptId) => {
          const entry = scriptMap[scriptId];
          if (!entry) {
            return;
          }

          if (previewContainer) {
            previewContainer.innerHTML = entry.html || '<div class="p-4 text-center text-muted">Preview unavailable for this script.</div>';
          }

          if (summaryEl) {
            summaryEl.textContent = entry.summary || 'Preview ready.';
          }

          if (downloadLink) {
            let href = entry.pdfUrl || null;
            if (!href && downloadBase) {
              const separator = downloadBase.includes('?') ? '&' : '?';
              href = `${downloadBase}${separator}script=${encodeURIComponent(scriptId)}`;
            }

            if (href) {
              downloadLink.href = href;
              downloadLink.classList.remove('disabled');
              downloadLink.setAttribute('aria-disabled', 'false');
              downloadLink.removeAttribute('tabindex');
            } else {
              downloadLink.href = '#';
              downloadLink.classList.add('disabled');
              downloadLink.setAttribute('aria-disabled', 'true');
              downloadLink.setAttribute('tabindex', '-1');
            }
          }
        };

        const defaultScript = mailerCard.dataset.defaultScript || (select ? select.value : null);
        if (select) {
          select.addEventListener('change', () => {
            applyScript(select.value);
          });
        }

        if (defaultScript) {
          applyScript(defaultScript);
        }
      }

      // Initialize skiptracing functionality
      const skiptraceCard = document.getElementById('parcel-skiptrace-card');
      if (skiptraceCard && window.LeadCRM && window.LeadCRM.skiptrace) {
        try {
          const config = JSON.parse('{{ skiptrace_config_json|escapejs }}');
          window.LeadCRM.skiptrace.init(skiptraceCard, config);
        } catch (error) {
          console.error('Failed to initialize skiptracing:', error);
        }
      }

    });

    // Auto-refresh page if lien search was just triggered
    {% if lien_search_requested %}
      (function() {
        const refreshDelay = 8000; // 8 seconds - enough time for background search to complete
        const currentUrl = new URL(window.location.href);

        // Show a countdown in the info banner
        const infoBanner = document.querySelector('.bg-info-subtle');
        if (infoBanner) {
          let secondsLeft = Math.floor(refreshDelay / 1000);
          const countdownEl = document.createElement('div');
          countdownEl.className = 'mt-2 fw-semibold';
          countdownEl.innerHTML = `Auto-refreshing in <span id="refresh-countdown">${secondsLeft}</span> seconds...`;
          infoBanner.appendChild(countdownEl);

          const countdownInterval = setInterval(() => {
            secondsLeft--;
            const countdownSpan = document.getElementById('refresh-countdown');
            if (countdownSpan) {
              countdownSpan.textContent = secondsLeft;
            }
            if (secondsLeft <= 0) {
              clearInterval(countdownInterval);
            }
          }, 1000);
        }

        // Schedule the refresh
        setTimeout(() => {
          // Remove the manual_search query param before refreshing
          currentUrl.searchParams.delete('manual_search');
          window.location.href = currentUrl.toString();
        }, refreshDelay);
      })();
    {% endif %}

    // Search public records for liens and legal actions
    function searchPublicRecords() {
      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Searching...';

      fetch('{% url "search_liens_legal_actions" parcel.town.town_id parcel.loc_id %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken') || '',
        },
      })
      .then(response => response.json())
      .then(data => {
        button.disabled = false;
        button.innerHTML = originalText;
        if (data.success) {
          showSearchResults(data);
        } else {
          alert('Search failed: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        button.disabled = false;
        button.innerHTML = originalText;
        alert('Search failed. Please try again.');
      });
    }

    function showSearchResults(data) {
      const modalHtml = `<div class="modal fade" id="searchResultsModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Search Results</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-info">${data.message}</div><h6>Legal Actions (${data.legal_actions.length})</h6><div id="legalActionsResults"></div><h6 class="mt-3">Liens (${data.liens.length})</h6><div id="liensResults"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" onclick="location.reload()">Reload Page</button></div></div></div></div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Render legal actions
      const legalHTML = data.legal_actions.map(a => `<div class="card mb-2"><div class="card-body p-2 small"><strong>${a.case_number}</strong> - ${a.source}<br>${a.description || ''}</div></div>`).join('');
      document.getElementById('legalActionsResults').innerHTML = legalHTML || '<p>None found</p>';
      
      // Render liens
      const lienHTML = data.liens.map(l => `<div class="card mb-2"><div class="card-body p-2 small"><strong>${l.source}</strong><br><pre style="white-space:pre-wrap;font-size:0.8em;">${l.notes || ''}</pre></div></div>`).join('');
      document.getElementById('liensResults').innerHTML = lienHTML || '<p>None found</p>';
      
      const modal = new bootstrap.Modal(document.getElementById('searchResultsModal'));
      modal.show();
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
{% endblock %}
